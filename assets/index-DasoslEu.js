(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const C=Math.PI/180;function B(h){return h*C}function K(h,t,e){return Math.max(Math.min(h,e),t)}class z{keybinds;eventListeners;keysDown;constructor(t){this.eventListeners=[],this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){if(this.eventListeners.length>0)return;const t={callback:this.onKeyDown.bind(this)},e={callback:this.onKeyUp.bind(this)};document.addEventListener("keydown",t.callback),document.addEventListener("keyup",e.callback)}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}removeEventListeners(){for(const{type:t,callback:e}of this.eventListeners)document.removeEventListener(t,e)}}class E{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this.components[4]=t.components[4],this.components[5]=t.components[5],this.components[6]=t.components[6],this.components[7]=t.components[7],this.components[8]=t.components[8],this.components[9]=t.components[9],this.components[10]=t.components[10],this.components[11]=t.components[11],this.components[12]=t.components[12],this.components[13]=t.components[13],this.components[14]=t.components[14],this.components[15]=t.components[15],this}static perspective(t,e,i,s){const n=new E,o=1/Math.tan(t/2);if(n.components[0]=o/e,n.components[5]=o,n.components[11]=-1,n.components[15]=0,s!==1/0){const a=1/(i-s);n.components[10]=s*a,n.components[14]=s*i*a}else n.components[10]=-1,n.components[14]=-i;return n}static lookAt(t,e,i){const s=new E,n=1e-6;let o,a,c,u,y,w,m,p,f,d;const b=t.x,g=t.y,S=t.z,k=i.x,T=i.y,A=i.z,O=e.x,F=e.y,D=e.z;return Math.abs(b-O)<n&&Math.abs(g-F)<n&&Math.abs(S-D)<n?(console.warn("Look At too close to Position"),new E):(m=b-O,p=g-F,f=S-D,d=1/Math.sqrt(m*m+p*p+f*f),m*=d,p*=d,f*=d,o=T*f-A*p,a=A*m-k*f,c=k*p-T*m,d=Math.sqrt(o*o+a*a+c*c),d?(d=1/d,o*=d,a*=d,c*=d):(o=0,a=0,c=0),u=p*c-f*a,y=f*o-m*c,w=m*a-p*o,d=Math.sqrt(u*u+y*y+w*w),d?(d=1/d,u*=d,y*=d,w*=d):(u=0,y=0,w=0),s.components[0]=o,s.components[1]=u,s.components[2]=m,s.components[3]=0,s.components[4]=a,s.components[5]=y,s.components[6]=p,s.components[7]=0,s.components[8]=c,s.components[9]=w,s.components[10]=f,s.components[11]=0,s.components[12]=-(o*b+a*g+c*S),s.components[13]=-(u*b+y*g+w*S),s.components[14]=-(m*b+p*g+f*S),s.components[15]=1,s)}}class l{static ZERO=new l;components;constructor(t=0,e=0,i=0){this.components=new Float32Array(3),this.components[0]=t,this.components[1]=e,this.components[2]=i}*[Symbol.iterator](){yield this.components[0],yield this.components[1],yield this.components[2]}static scale(t,e){return new l(t.components[0]*e,t.components[1]*e,t.components[2]*e)}static add(t,e){return t.clone().add(e)}static subtract(t,e){return t.clone().subtract(e)}static cross(t,e){const i=t.components[0],s=t.components[1],n=t.components[2],o=e.components[0],a=e.components[1],c=e.components[2];return new l(s*c-n*a,n*o-i*c,i*a-s*o)}add(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this}subtract(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this}multiply(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this.components[2]*=t.components[2],this}scale(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}normalise(){const t=1/this.magnitude;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}clone(){return new l(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class W{position;fieldOfView;aspectRatio;near;far;movementSpeed;mouseSensitivity;keybinds;forward;up;pitch;yaw;keyboardManager;constructor(t={}){this.position=t.position??new l,this.fieldOfView=t.fieldOfView??60,this.aspectRatio=t.aspectRatio??16/9,this.near=t.near??.001,this.far=t.far??1e3,this.movementSpeed=t.movementSpeed??.05,this.mouseSensitivity=t.mouseSensitivity??.1,this.forward=new l(0,0,-1),this.up=new l(0,1,0),this.pitch=0,this.yaw=-90,this.keybinds={forwards:t.keybinds?.forwards??"KeyW",backwards:t.keybinds?.backwards??"KeyS",left:t.keybinds?.left??"KeyA",right:t.keybinds?.right??"KeyD",up:t.keybinds?.up??"Space",down:t.keybinds?.down??"ShiftLeft"},this.keyboardManager=new z(Object.values(this.keybinds)),this.addEventListeners()}getPerspectiveMatrix(){return E.perspective(B(this.fieldOfView),this.aspectRatio,this.near,this.far)}getViewMatrix(){return E.lookAt(this.position,l.add(this.position,this.forward),this.up)}checkKeyboardInputs(){if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const t=this.forward.clone();t.y=0,this.position.add(l.scale(t.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const t=this.forward.clone();t.y=0,this.position.subtract(l.scale(t.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const t=this.forward.clone();t.y=0,this.position.subtract(l.scale(l.cross(t,this.up).normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const t=this.forward.clone();t.y=0,this.position.add(l.scale(l.cross(t,this.up).normalise(),this.movementSpeed))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=this.movementSpeed),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=this.movementSpeed)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",t=>{const e=t.movementX*this.mouseSensitivity,i=-t.movementY*this.mouseSensitivity;this.yaw+=e,this.pitch=K(-89,this.pitch+i,89);const s=B(this.yaw),n=B(this.pitch),o=Math.cos(s),a=Math.cos(n),c=Math.sin(s),u=Math.sin(n),y=new l(o*a,u,c*a).normalise();this.forward=y})}}class q{constructor(t,e=""){this.vertices=t,this.label=e,this.initialised=!1}vertexBuffer;initialised;initialise(t){if(this.initialised)return;const e=new Float32Array(this.vertices);this.vertexBuffer=t.createBuffer({label:this.label,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.vertexBuffer,0,e),this.initialised=!0}get verticeCount(){return this.vertices.length/3}}class _ extends E{constructor(t){super(),this.label=t,this.initialised=!1}device;buffer;initialised;initialise(t,e=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){if(this.initialised){console.warn("Matrix4Buffer already initialised");return}this.buffer=t.createBuffer({label:this.label,size:64,usage:e}),this.device=t,this.initialised=!0}writeBuffer(){this.initialised||console.error("Matrix4Buffer not initialised"),this.device.queue.writeBuffer(this.buffer,0,this.components)}}class v{constructor(t,e){this.code=t,this.label=e,this.initialised=!1}static BASE_PATH="/Ocean-Simulation/shaders";initialised;shaderModule;static async from(t,e){const s=(typeof t=="string"?[t]:t).map(o=>fetch(v.resolveBasePath(o)).then(a=>a.text())),n=(await Promise.all(s)).join("");return new v(n,e)}static resolveBasePath(t){return v.BASE_PATH===""?t:`${v.BASE_PATH}/${t}.wgsl`}initialise(t){if(this.initialised)return;const e=t.createShaderModule({label:this.label,code:this.code});this.shaderModule=e,this.initialised=!0}}class r{constructor(t){this.seed=t,this.state=[],this.stateIndex=0,this.setSeed(t)}static WORD_SIZE=32;static RECURSION_DEGREE=624;static MIDDLE_WORD=397;static ONE_WORD_SEPARATION_POINT=31;static MATRIX_A_BOTTOM_ROW=2567483615;static TEMPERING_BIT_SHIFT_1=11;static TEMPERING_BIT_SHIFT_2=7;static TEMPERING_BIT_SHIFT_3=15;static TEMPERING_BIT_SHIFT_4=18;static TEMPERING_MASK_1=2636928640;static TEMPERING_MASK_2=4022730752;static UPPER_MASK=4294967295<<r.ONE_WORD_SEPARATION_POINT;static LOWER_MASK=4294967295>>>r.WORD_SIZE-r.ONE_WORD_SEPARATION_POINT;static f=1812433253;state;stateIndex;setSeed(t){this.state[0]=t;for(let e=1;e<r.RECURSION_DEGREE;e++)t=r.f*(t^t>>>r.WORD_SIZE-2)+e,this.state[e]=t}randomInt(){let t=this.stateIndex-(r.RECURSION_DEGREE-1);t<0&&(t+=r.RECURSION_DEGREE);let e=this.getState()&r.UPPER_MASK|this.getState(t)&r.LOWER_MASK,i=e>>>1;e&1&&(i^=r.MATRIX_A_BOTTOM_ROW),t=this.stateIndex-(r.RECURSION_DEGREE-r.MIDDLE_WORD),t<0&&(t+=r.RECURSION_DEGREE),e=this.getState(t)^i,this.state[this.stateIndex++]=e,this.stateIndex>=r.RECURSION_DEGREE&&(this.stateIndex=0);let s=e^e>>>r.TEMPERING_BIT_SHIFT_1;return s^=s<<r.TEMPERING_BIT_SHIFT_2&r.TEMPERING_MASK_1,s^=s<<r.TEMPERING_BIT_SHIFT_3&r.TEMPERING_MASK_2,s^=s>>>r.TEMPERING_BIT_SHIFT_4,2147483647&s}randomFloat(){return this.randomInt()/2147483647}randomFloatRange(t,e){return(e-t)*this.randomFloat()+t}getState(t=this.stateIndex){return this.state[t]}}new r(0);function P(h,t){return(t-h)*Math.random()+h}const V=Math.PI*2;class x{components;constructor(t=0,e=0){this.components=new Float32Array(2),this.components[0]=t,this.components[1]=e}normalise(){const t=1/this.magnitude;return this.components[0]*=t,this.components[1]*=t,this}get x(){return this.components[0]}get y(){return this.components[1]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}get magnitude(){return Math.hypot(this.components[0],this.components[1])}static randomUnit(){const t=P(0,V),e=Math.cos(t),i=Math.sin(t);return new x(e,i).normalise()}}const G=Math.PI*2;class I{constructor(t,e,i,s){this.wavelength=t,this.speed=e,this.amplitude=i,this.direction=s}static BYTE_SIZE=8*Float32Array.BYTES_PER_ELEMENT;writeToBuffer(t){t.writeFloat32(this.frequency),t.writeFloat32(this.amplitude),t.writeFloat32(this.phaseConstant),t.pad(4),t.writeVec2f32(this.direction),t.pad(8)}get frequency(){return G/this.wavelength}get phaseConstant(){return this.speed*G/this.wavelength}static random(){const t=P(.5,1.5),e=P(.4,.6),i=P(.1,.5),s=x.randomUnit();return new I(t,e,i,s)}}class Y{constructor(t=new ArrayBuffer,e=!0,i=0){this.littleEndian=e,this.offset=i,this.buffer=t instanceof ArrayBuffer?t:new ArrayBuffer(t),this.dataview=new DataView(this.buffer)}buffer;dataview;toFloat32Array(){return new Float32Array(this.buffer)}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeVec2f32(t){this.writeFloat32(t.x),this.writeFloat32(t.y)}writeVec3f32(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeBooleanAsUint32(t){this.writeUint32(t?1:0)}pad(t){for(let e=0;e<t;e++)this.dataview.setUint8(this.offset,0),this.offset+=1}}const X={arrayStride:Float32Array.BYTES_PER_ELEMENT*3,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class R{constructor(t,e,i){this.device=t,this.canvas=e;const s=this.canvas.getContext("webgpu");if(s===null)throw new Error("Could not get WebGPU Canvas context");this.ctx=s,this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),this.initialised=!1;const n=Object.assign(structuredClone(R.DEFAULT_SETTINGS),i);this.settings=n,this.perspectiveMatrix=new _("Perspective Matrix"),this.viewMatrix=new _("View Matrix"),this.perspectiveMatrix.initialise(t),this.viewMatrix.initialise(t),new ResizeObserver(o=>{const a=o[0],c=a.devicePixelContentBoxSize[0].inlineSize,u=a.devicePixelContentBoxSize[0].blockSize;this.canvas.width=c,this.canvas.height=u}).observe(this.canvas)}static DEFAULT_SETTINGS={wireframe:!1,waves:3};settings;ctx;canvasFormat;initialised;renderShaderModule;renderBindGroup;renderPipeline;perspectiveMatrix;viewMatrix;settingsBuffer;wavesBuffer;async initialise(){if(this.initialised)return;this.ctx.configure({device:this.device,format:this.canvasFormat}),this.renderShaderModule=await v.from("render","Render Shader Module"),this.renderShaderModule.initialise(this.device),this.settingsBuffer=this.device.createBuffer({label:"Settings Buffer",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.wavesBuffer=this.device.createBuffer({label:"Waves Buffer",size:this.settings.waves*I.BYTE_SIZE,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const t=new Y(this.settings.waves*I.BYTE_SIZE),e=Array.from(Array(this.settings.waves),()=>I.random());for(const n of e)n.writeToBuffer(t);this.device.queue.writeBuffer(this.wavesBuffer,0,t.toFloat32Array());const i=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:2,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:3,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:i,entries:[{binding:0,resource:{buffer:this.perspectiveMatrix.buffer}},{binding:1,resource:{buffer:this.viewMatrix.buffer}},{binding:2,resource:{buffer:this.settingsBuffer}},{binding:3,resource:{buffer:this.wavesBuffer}}]});const s=this.device.createPipelineLayout({label:"Render Pipeline Layout",bindGroupLayouts:[i]});this.renderPipeline=this.device.createRenderPipeline({label:"Render Pipeline",layout:s,vertex:{module:this.renderShaderModule.shaderModule,entryPoint:"vertexMain",buffers:[X]},fragment:{module:this.renderShaderModule.shaderModule,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{topology:this.settings.wireframe?"line-strip":"triangle-list"}}),this.initialised=!0}render(t,e,i){if(!this.initialised){console.error("Renderer not initialised");return}e.initialise(this.device),t.aspectRatio=this.canvas.width/this.canvas.height,this.viewMatrix.copyFrom(t.getViewMatrix()).writeBuffer(),this.perspectiveMatrix.copyFrom(t.getPerspectiveMatrix()).writeBuffer(),this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([i]));const s=this.device.createCommandEncoder({label:"Render Command Encoder"}),n=s.beginRenderPass({label:"Render Pass",colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});n.setViewport(0,0,this.canvas.width,this.canvas.height,0,1),n.setVertexBuffer(0,e.vertexBuffer),n.setBindGroup(0,this.renderBindGroup),n.setPipeline(this.renderPipeline),n.draw(e.verticeCount),n.end(),this.device.queue.submit([s.finish()])}static async create(t,e={}){if(!navigator.gpu)throw new Error("WebGPU not supported");const i=await navigator.gpu.requestAdapter();if(i===null)throw new Error("No GPU Adapter found");const s=await i.requestDevice();return new R(s,t,e)}}class H{callbacks;animationFrameID;lastTick;constructor(){this.callbacks=[],this.animationFrameID=null,this.lastTick=0}start(){this.animationFrameID!==null&&cancelAnimationFrame(this.animationFrameID),this.tick(0)}stop(){this.animationFrameID!==null&&(cancelAnimationFrame(this.animationFrameID),this.animationFrameID=null)}tick(t){const i={deltaTimeMS:t-this.lastTick,totalTimeMS:t};for(const s of this.callbacks)s(i);this.lastTick=t,this.animationFrameID=requestAnimationFrame(s=>this.tick.bind(this)(s))}addCallback(t){this.callbacks.push(t)}removeCallback(t){const e=this.callbacks.findIndex(i=>i===t);if(e===-1){console.warn("Callback not found");return}this.callbacks.splice(e,1)}}const M=document.querySelector("canvas");if(M===null)throw new Error("Could not find canvas");M.addEventListener("click",()=>{M.requestPointerLock()});const L=await R.create(M,{wireframe:!1});await L.initialise();const U=new W({position:new l(0,1,5)}),Z=new q($(500,10),"Square"),N=new H,j=h=>{const t=h.totalTimeMS/1e3;U.checkKeyboardInputs(),L.render(U,Z,t)};N.addCallback(j);N.start();function $(h,t){const e=t/h/2,i=.5*(1-1/h)*t,s=[e-i,0,-.01-i,e-i,0,e-i,-.01-i,0,e-i,-.01-i,0,-.01-i,e-i,0,-.01-i,-.01-i,0,e-i],n=[];for(let o=0;o<h;o++)for(let a=0;a<h;a++)for(let c=0;c<s.length;c++){const u=s[c];switch(c%3){case 0:n.push(u+o*e*2);break;case 1:n.push(u);break;case 2:n.push(u+a*e*2);break}}return n}
