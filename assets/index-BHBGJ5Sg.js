(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const K=Math.PI/180;function D(c){return c*K}class ${constructor(e=new ArrayBuffer,t=!0,i=0){this.littleEndian=t,this.offset=i,this.buffer=e instanceof ArrayBuffer?e:new ArrayBuffer(e),this.dataview=new DataView(this.buffer)}buffer;dataview;toFloat32Array(){return new Float32Array(this.buffer)}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeVec2f32(e){this.writeFloat32(e.x),this.writeFloat32(e.y)}writeVec3f32(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}writeBooleanAsUint32(e){this.writeUint32(e?1:0)}pad(e){for(let t=0;t<e;t++)this.dataview.setUint8(this.offset,0),this.offset+=1}}function X(c,e,t){return Math.max(Math.min(c,t),e)}class W{keybinds;eventListeners;keysDown;constructor(e){this.eventListeners=[],this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){if(this.eventListeners.length>0)return;const e={callback:this.onKeyDown.bind(this)},t={callback:this.onKeyUp.bind(this)};document.addEventListener("keydown",e.callback),document.addEventListener("keyup",t.callback)}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}removeEventListeners(){for(const{type:e,callback:t}of this.eventListeners)document.removeEventListener(e,t)}}class M{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],i=this.components[2],s=this.components[3],n=this.components[4],r=this.components[5],o=this.components[6],a=this.components[7],u=this.components[8],m=this.components[9],b=this.components[10],y=this.components[11],g=this.components[12],w=this.components[13],l=this.components[14],x=this.components[15],B=e*r-t*n,S=e*o-i*n,T=e*a-s*n,h=t*o-i*r,p=t*a-s*r,d=i*a-s*o,f=u*w-m*g,E=u*l-b*g,k=u*x-y*g,L=m*l-b*w,R=m*x-y*w,A=b*x-y*l,Y=B*A-S*R+T*L+h*k-p*E+d*f;if(Y===0)return console.warn("Determinant is 0. Matrix not inverted"),this;const G=1/Y;return this.components[0]=(r*A-o*R+a*L)*G,this.components[1]=(i*R-t*A-s*L)*G,this.components[2]=(w*d-l*p+x*h)*G,this.components[3]=(b*p-m*d-y*h)*G,this.components[4]=(o*k-n*A-a*E)*G,this.components[5]=(e*A-i*k+s*E)*G,this.components[6]=(l*T-g*d-x*S)*G,this.components[7]=(u*d-b*T+y*S)*G,this.components[8]=(n*R-r*k+a*f)*G,this.components[9]=(t*k-e*R-s*f)*G,this.components[10]=(g*p-w*T+x*B)*G,this.components[11]=(m*T-u*p-y*B)*G,this.components[12]=(r*E-n*L-o*f)*G,this.components[13]=(e*L-t*E+i*f)*G,this.components[14]=(w*S-g*h-l*B)*G,this.components[15]=(u*h-m*S+b*B)*G,this}preMultiply(e){return M.multiply(e,this,this),this}postMultiply(e){return M.multiply(this,e,this),this}static multiply(e,t,i=new M){const s=e.components[0],n=e.components[1],r=e.components[2],o=e.components[3],a=e.components[4],u=e.components[5],m=e.components[6],b=e.components[7],y=e.components[8],g=e.components[9],w=e.components[10],l=e.components[11],x=e.components[12],B=e.components[13],S=e.components[14],T=e.components[15];let h=t.components[0],p=t.components[1],d=t.components[2],f=t.components[3];return i.components[0]=h*s+p*a+d*y+f*x,i.components[1]=h*n+p*u+d*g+f*B,i.components[2]=h*r+p*m+d*w+f*S,i.components[3]=h*o+p*b+d*l+f*T,h=t.components[4],p=t.components[5],d=t.components[6],f=t.components[7],i.components[4]=h*s+p*a+d*y+f*x,i.components[5]=h*n+p*u+d*g+f*B,i.components[6]=h*r+p*m+d*w+f*S,i.components[7]=h*o+p*b+d*l+f*T,h=t.components[8],p=t.components[9],d=t.components[10],f=t.components[11],i.components[8]=h*s+p*a+d*y+f*x,i.components[9]=h*n+p*u+d*g+f*B,i.components[10]=h*r+p*m+d*w+f*S,i.components[11]=h*o+p*b+d*l+f*T,h=t.components[12],p=t.components[13],d=t.components[14],f=t.components[15],i.components[12]=h*s+p*a+d*y+f*x,i.components[13]=h*n+p*u+d*g+f*B,i.components[14]=h*r+p*m+d*w+f*S,i.components[15]=h*o+p*b+d*l+f*T,i}static perspective(e,t,i,s){const n=new M,r=1/Math.tan(e/2);if(n.components[0]=r/t,n.components[5]=r,n.components[11]=-1,n.components[15]=0,s!==1/0){const o=1/(i-s);n.components[10]=s*o,n.components[14]=s*i*o}else n.components[10]=-1,n.components[14]=-i;return n}static lookAt(e,t,i){const s=new M,n=1e-6;let r,o,a,u,m,b,y,g,w,l;const x=e.x,B=e.y,S=e.z,T=i.x,h=i.y,p=i.z,d=t.x,f=t.y,E=t.z;return Math.abs(x-d)<n&&Math.abs(B-f)<n&&Math.abs(S-E)<n?(console.warn("Look At too close to Position"),new M):(y=x-d,g=B-f,w=S-E,l=1/Math.sqrt(y*y+g*g+w*w),y*=l,g*=l,w*=l,r=h*w-p*g,o=p*y-T*w,a=T*g-h*y,l=Math.sqrt(r*r+o*o+a*a),l?(l=1/l,r*=l,o*=l,a*=l):(r=0,o=0,a=0),u=g*a-w*o,m=w*r-y*a,b=y*o-g*r,l=Math.sqrt(u*u+m*m+b*b),l?(l=1/l,u*=l,m*=l,b*=l):(u=0,m=0,b=0),s.components[0]=r,s.components[1]=u,s.components[2]=y,s.components[3]=0,s.components[4]=o,s.components[5]=m,s.components[6]=g,s.components[7]=0,s.components[8]=a,s.components[9]=b,s.components[10]=w,s.components[11]=0,s.components[12]=-(r*x+o*B+a*S),s.components[13]=-(u*x+m*B+b*S),s.components[14]=-(y*x+g*B+w*S),s.components[15]=1,s)}}class P{static ZERO=new P;components;constructor(e=0,t=0,i=0){this.components=new Float32Array(3),this.components[0]=e,this.components[1]=t,this.components[2]=i}*[Symbol.iterator](){yield this.components[0],yield this.components[1],yield this.components[2]}static scale(e,t){return new P(e.components[0]*t,e.components[1]*t,e.components[2]*t)}static add(e,t){return e.clone().add(t)}static subtract(e,t){return e.clone().subtract(t)}static cross(e,t){const i=e.components[0],s=e.components[1],n=e.components[2],r=t.components[0],o=t.components[1],a=t.components[2];return new P(s*a-n*o,n*r-i*a,i*o-s*r)}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}multiply(e){return this.components[0]*=e.components[0],this.components[1]*=e.components[1],this.components[2]*=e.components[2],this}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}normalise(){const e=1/this.magnitude;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}clone(){return new P(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class C{static BYTE_SIZE=32*Float32Array.BYTES_PER_ELEMENT;position;fieldOfView;aspectRatio;near;far;movementSpeed;mouseSensitivity;keybinds;forward;up;pitch;yaw;keyboardManager;constructor(e={}){this.position=e.position??new P,this.fieldOfView=e.fieldOfView??60,this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.001,this.far=e.far??1e3,this.movementSpeed=e.movementSpeed??.05,this.mouseSensitivity=e.mouseSensitivity??.1,this.forward=new P(0,0,-1),this.up=new P(0,1,0),this.pitch=0,this.yaw=-90,this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new W(Object.values(this.keybinds)),this.addEventListeners()}getPerspectiveMatrix(){return M.perspective(D(this.fieldOfView),this.aspectRatio,this.near,this.far)}getViewMatrix(){return M.lookAt(this.position,P.add(this.position,this.forward),this.up)}getPerspectiveViewMatrix(){return this.getPerspectiveMatrix().postMultiply(this.getViewMatrix())}writeToBuffer(){const e=new $(C.BYTE_SIZE);return e.writeMat4x4f(this.getPerspectiveViewMatrix()),e.writeVec3f32(this.position),e.pad(4),e.writeVec3f32(this.forward.normalise()),e.toFloat32Array()}checkKeyboardInputs(){if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const e=this.forward.clone();e.y=0,this.position.add(P.scale(e.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const e=this.forward.clone();e.y=0,this.position.subtract(P.scale(e.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const e=this.forward.clone();e.y=0,this.position.subtract(P.scale(P.cross(e,this.up).normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const e=this.forward.clone();e.y=0,this.position.add(P.scale(P.cross(e,this.up).normalise(),this.movementSpeed))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=this.movementSpeed),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=this.movementSpeed)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,i=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=X(this.pitch+i,-89,89);const s=D(this.yaw),n=D(this.pitch),r=Math.cos(s),o=Math.cos(n),a=Math.sin(s),u=Math.sin(n),m=new P(r*o,u,a*o).normalise();this.forward=m})}}class j{constructor(e,t,i=""){this.vertices=e,this.indices=t,this.label=i,this.initialised=!1}vertexBuffer;indexBuffer;initialised;initialise(e){if(this.initialised)return;const t=new Float32Array(this.vertices),i=new(this.indexFormat==="uint16"?Uint16Array:Uint32Array)(this.indices);this.vertexBuffer=e.createBuffer({label:`${this.label} Vertex Buffer`,size:t.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.indexBuffer=e.createBuffer({label:`${this.label} Index Buffer`,size:i.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.vertexBuffer,0,t),e.queue.writeBuffer(this.indexBuffer,0,i),this.initialised=!0}render(e){if(!this.initialised){console.error(`Mesh ${this.label} not initialised`);return}this.bind(e),e.drawIndexed(this.indexCount)}bind(e){if(!this.initialised){console.error(`Mesh ${this.label} not initialised`);return}e.setVertexBuffer(0,this.vertexBuffer),e.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.vertices.length/3}get indexCount(){return this.indices.length}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}function H(c){return`/Ocean-Simulation/${c}`}class v{constructor(e,t){this.code=e,this.label=t,this.initialised=!1}initialised;shaderModule;static async joinURLContents(e){const t=e.map(i=>fetch(H(`shaders/${i}.wgsl`)).then(s=>s.text()));return(await Promise.all(t)).join("")}static async from(e,t){const i=typeof e=="string"?[e]:e,s=await v.joinURLContents(i);return new v(s,t)}initialise(e){if(this.initialised){console.warn("Shader already initialised");return}const t=e.createShaderModule({label:this.label,code:this.code});this.shaderModule=t,this.initialised=!0}}class Z{constructor(e=""){this.label=e,this.initialised=!1}initialised;texture;async initialise(e,...t){if(this.initialised)return;const i=t.map(async r=>await(await fetch(H(r))).blob()),s=await Promise.all(i),n=await Promise.all(s.map(r=>createImageBitmap(r)));this.texture=e.createTexture({label:this.label,format:"rgba8unorm",size:[n[0].width,n[0].height,n.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let r=0;r<n.length;r++){const o=n[r];e.queue.copyExternalImageToTexture({source:o},{texture:this.texture,origin:[0,0,r]},{width:o.width,height:o.height})}this.initialised=!0}}class J extends Z{async initialise(e,...t){if(t.length!==6)throw new Error("Exactly 6 textures needed for Cubemap");for(const i of t){const s=i.split("/").at(-1)?.split(".").slice(0,-1).join("")??"";if(!/^[np][xyz]$/.test(s))throw new Error(`Invalid url ${i}. File name must be in the format of (n or p)(x, y, or z)`)}await super.initialise(e,...t)}}class Q extends M{constructor(e){super(),this.label=e,this.initialised=!1}device;buffer;initialised;initialise(e,t=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){if(this.initialised){console.warn("Matrix4Buffer already initialised");return}this.buffer=e.createBuffer({label:this.label,size:64,usage:t}),this.device=e,this.initialised=!0}writeBuffer(){if(!this.initialised){console.error("Matrix4Buffer not initialised");return}this.device.queue.writeBuffer(this.buffer,0,this.components)}}class ee{constructor(e="",...t){this.label=e,this.activeSkybox=t.length-1,this.skyboxes=t,this.bindGroups=[],this.inversePespectiveViewMatrix=new Q(`Skybox ${this.label} Inverse Perspective View Matrix Butter`),this.initialised=!1}initialised;inversePespectiveViewMatrix;bindGroups=[];activeSkybox;device;renderBindGroupLayout;renderPipeline;skyboxes;sampler;async initialise(e,t){if(this.initialised)return;this.device=e,this.sampler=e.createSampler({label:`Skybox Renderer ${this.label} Sampler`}),this.inversePespectiveViewMatrix.initialise(e);const i=await v.from("skybox",`Skybox Renderer "${this.label}" Shader Module`);i.initialise(e),this.renderBindGroupLayout=e.createBindGroupLayout({label:`Skybox Renderer "${this.label}" Bind Group Layout`,entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const s=e.createPipelineLayout({label:`Skybox Renderer "${this.label}" Render Pipeline Layout`,bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=e.createRenderPipeline({label:`Skybox Renderer "${this.label}" Render Pipeline`,layout:s,vertex:{module:i.shaderModule,entryPoint:"vertexMain"},fragment:{module:i.shaderModule,entryPoint:"fragmentMain",targets:[{format:t}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}});for(let n=0,r=this.skyboxes.length;n<r;n++){const o=this.skyboxes[n];this.skyboxes.splice(0,1),this.addSkybox(o)}this.initialised=!0}addSkybox(e){const t=this.device.createBindGroup({label:`Skybox Renderer "${e.label}" Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix.buffer}}]});this.skyboxes.push(e),this.bindGroups.push(t)}setActiveSkybox(e){if(e===null){this.activeSkybox=-1;return}this.skyboxes.includes(e)||this.addSkybox(e);const t=this.skyboxes.findIndex(i=>i===e);this.activeSkybox=t}render(e,t){if(!this.initialised){console.error(`Skybox Renderer "${this.label}" not initialised`);return}if(this.activeSkybox===-1){console.warn("No active skybox");return}this.inversePespectiveViewMatrix.copyFrom(t.getPerspectiveViewMatrix().invert()),this.inversePespectiveViewMatrix.writeBuffer(),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroups[this.activeSkybox]),e.draw(3)}}function U(c,e,t,i){const s=i.createCommandEncoder(),n=s.beginComputePass();n.setBindGroup(0,c),n.setPipeline(e),n.dispatchWorkgroups(...t),n.end(),i.queue.submit([s.finish()])}class O{constructor(e,t,i){this.device=e,this.height=t,i.initialise(e),this.settingsBuffer=e.createBuffer({label:"Butterfly Texture Settings Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),e.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([t]));const s=e.createBuffer({label:"Butterfly Texture Bit Reversed Indices",size:t*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE});e.queue.writeBuffer(s,0,this.bitReverseIndices(t)),this.butterflyTexture=e.createTexture({label:"Butterfly Texture",format:"rgba32float",size:[Math.log2(t),t],usage:GPUTextureUsage.STORAGE_BINDING});const n=e.createBindGroupLayout({label:"Butterfly Texture Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Butterfly Texture Bind Group",layout:n,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:s}},{binding:2,resource:this.butterflyTexture.createView()}]});const r=e.createPipelineLayout({label:"Butterfly Texture Pipeline Layout",bindGroupLayouts:[n]});this.pipeline=e.createComputePipeline({label:"Butterfly Texture Pipeline Layout",layout:r,compute:{module:i.shaderModule,entryPoint:"main"}})}butterflyTexture;settingsBuffer;bindGroup;pipeline;createTexture(){U(this.bindGroup,this.pipeline,[Math.log2(this.height),this.height,1],this.device)}bitReverseIndices(e){const t=new Float32Array(e),i=Math.log2(e);for(let s=0;s<e;s++){let n=0;for(let r=0;r<i;r++)s&1<<r&&(n|=1<<i-1-r);t[s]=n}return t}static async create(e,t){const i=await v.from(["butterflyTexture","complexNumber"],"Butterfly Texture Shader Module");return new O(e,t,i)}}class I{constructor(e,t,i,s){this.device=e,this.textureSize=i,s.initialise(e);const n=e.createBuffer({label:"Spectrum Settings Buffer",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(n,0,new Float32Array([t,i])),this.spectrumTexture=e.createTexture({label:"Spectrum Texture",format:"rgba32float",size:[i,i],usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING});const r=e.createBindGroupLayout({label:"Spectrum Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Spectrum Bind Group",layout:r,entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:this.spectrumTexture.createView()}]});const o=e.createPipelineLayout({label:"Spectrum Compute Pipeline Layout",bindGroupLayouts:[r]});this.pipeline=e.createComputePipeline({label:"Spectrum Compute Pipeline",layout:o,compute:{module:s.shaderModule,entryPoint:"main"}})}bindGroup;pipeline;spectrumTexture;createSpectrum(){U(this.bindGroup,this.pipeline,[this.textureSize/8,this.textureSize/8,1],this.device)}static async create(e,t,i){const s=await v.from(["spectrum","random","complexNumber"],"Height Field Shader Module");return new I(e,t,i,s)}}class N{constructor(e,t,i,s,n){this.device=e,this.spectrum=t,this.domainSize=i,this.textureSize=s,n.initialise(e),this.spectrum.createSpectrum(),this.settingsBuffer=e.createBuffer({label:"Height Amplitudes Settings Buffer",size:3*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.writeSettings(0,i),this.texture=e.createTexture({label:"Height Amplitudes Texture",format:"rg32float",size:[s,s],usage:GPUTextureUsage.STORAGE_BINDING});const r=e.createBindGroupLayout({label:"Height Amplitudes Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Height Amplitudes Bind Group",layout:r,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:this.spectrum.spectrumTexture.createView()},{binding:2,resource:this.texture.createView()}]});const o=e.createPipelineLayout({label:"Height Amplitudes Pipeline Layout",bindGroupLayouts:[r]});this.pipeline=e.createComputePipeline({label:"Height Amplitudes Pipeline",layout:o,compute:{module:n.shaderModule,entryPoint:"main"}})}settingsBuffer;bindGroup;pipeline;texture;createSpectrum(e){this.writeSettings(e,this.domainSize),U(this.bindGroup,this.pipeline,[64,64,1],this.device)}writeSettings(e,t){this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([e,t,this.textureSize]))}static async create(e,t,i){const s=await v.from(["heightAmplitudes","complexNumber"],"Height Amplitudes Shader Module"),n=await I.create(e,t,i);return new N(e,n,t,i,s)}}class V{constructor(e,t,i,s,n){this.device=e,this.textureSize=n,this.pingPong=0,i.initialise(e),this.settingsBuffer=e.createBuffer({label:"Butterfly Settings Buffer",size:1*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.texture_1=s,this.texture_2=e.createTexture({label:"Butterfly Ping Pong Texture",format:"rg32float",size:[n,n],usage:GPUTextureUsage.STORAGE_BINDING});const r=e.createBindGroupLayout({label:"Butterfly Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:3,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup_1=e.createBindGroup({label:"Butterfly Bind Group 1",layout:r,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:t.butterflyTexture.createView()},{binding:2,resource:this.texture_1.createView()},{binding:3,resource:this.texture_2.createView()}]}),this.bindGroup_2=e.createBindGroup({label:"Butterfly Bind Group 2",layout:r,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:t.butterflyTexture.createView()},{binding:2,resource:this.texture_2.createView()},{binding:3,resource:this.texture_1.createView()}]});const o=e.createPipelineLayout({label:"Butterfly Pipeline Layout",bindGroupLayouts:[r]});this.pipelineHorizontal=e.createComputePipeline({label:"Butterfly Pipeline Horizontal",layout:o,compute:{module:i.shaderModule,entryPoint:"horizontal"}}),this.pipelineVertical=e.createComputePipeline({label:"Butterfly Pipeline Vertical",layout:o,compute:{module:i.shaderModule,entryPoint:"vertical"}})}settingsBuffer;bindGroup_1;bindGroup_2;pipelineHorizontal;pipelineVertical;texture_1;texture_2;pingPong;call(){this.pingPong=0;const e=Math.log2(this.textureSize);for(let t=0;t<e;t++)this.setStage(t),this.horizontal(),this.pingPong=(this.pingPong+1)%2;for(let t=0;t<e;t++)this.setStage(t),this.vertical(),this.pingPong=(this.pingPong+1)%2}horizontal(){U(this.pingPong===0?this.bindGroup_1:this.bindGroup_2,this.pipelineHorizontal,[this.textureSize,this.textureSize,1],this.device)}vertical(){U(this.pingPong===0?this.bindGroup_1:this.bindGroup_2,this.pipelineVertical,[this.textureSize,this.textureSize,1],this.device)}setStage(e){this.device.queue.writeBuffer(this.settingsBuffer,0,new Uint32Array([e]))}static async create(e,t,i,s){const n=await v.from(["butterfly","complexNumber"],"IFFT Shader Module"),r=s||await O.create(e,t);return s===void 0&&r.createTexture(),new V(e,r,n,i,t)}}class _{constructor(e,t,i,s){this.device=e,this.textureSize=i,this.ifft=s,t.initialise(e);const n=e.createBuffer({label:"Permute Settings Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});e.queue.writeBuffer(n,0,new Float32Array([i])),this.heightMap=e.createTexture({label:"Wave Height Map",size:[i,i],format:"rgba32float",usage:GPUTextureUsage.STORAGE_BINDING});const r=e.createBindGroupLayout({label:"Permute Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup_1=e.createBindGroup({label:"Permute Bind Group",layout:r,entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:s.texture_1.createView()},{binding:2,resource:this.heightMap.createView()}]}),this.bindGroup_2=e.createBindGroup({label:"Permute Bind Group",layout:r,entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:s.texture_2.createView()},{binding:2,resource:this.heightMap.createView()}]});const o=e.createPipelineLayout({label:"Permute Pipeline Layout",bindGroupLayouts:[r]});this.pipeline=e.createComputePipeline({label:"Permute Pipeline",layout:o,compute:{module:t.shaderModule,entryPoint:"main"}})}bindGroup_1;bindGroup_2;pipeline;heightMap;createHeightMap(){this.ifft.call();const e=this.ifft.pingPong===0?this.bindGroup_1:this.bindGroup_2;U(e,this.pipeline,[this.textureSize,this.textureSize,1],this.device)}static async create(e,t,i){const s=await v.from("permute","Permute Shader Module");return new _(e,s,t,i)}}class z{constructor(e,t){this.permute=e,this.heightAmplitudes=t}create(e){this.heightAmplitudes.createSpectrum(e),this.permute.createHeightMap()}get heightMap(){return this.permute.heightMap}static async create(e,t,i){const s=await N.create(e,t,i),n=await O.create(e,i);n.createTexture();const r=await V.create(e,i,s.texture,n),o=await _.create(e,i,r);return new z(o,s)}}const te={arrayStride:Float32Array.BYTES_PER_ELEMENT*3,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class F{constructor(e,t,i){this.device=e,this.canvas=t;const s=this.canvas.getContext("webgpu");if(s===null)throw new Error("Could not get WebGPU Canvas context");this.ctx=s,this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),this.skyboxRenderer=new ee("Renderer Skybox"),this.initialised=!1;const n=Object.assign(structuredClone(F.DEFAULT_SETTINGS),i);this.settings=n,new ResizeObserver(r=>{const o=r[0],a=o.devicePixelContentBoxSize[0].inlineSize,u=o.devicePixelContentBoxSize[0].blockSize;this.canvas.width=a,this.canvas.height=u,this.initialised&&(this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture())}).observe(this.canvas)}static DEFAULT_SETTINGS={wireframe:!1};settings;canvasFormat;skyboxRenderer;ctx;initialised;renderBindGroup;renderPipeline;depthTexture;cameraBuffer;renderSettingsBuffer;waveHeightMap;async initialise(){this.initialised||(this.waveHeightMap=await z.create(this.device,2e3,512),await this.initialiseRendering())}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const e=new J("Cubemap");await e.initialise(this.device,"skybox/px.png","skybox/nx.png","skybox/py.png","skybox/ny.png","skybox/pz.png","skybox/nz.png"),await this.skyboxRenderer.initialise(this.device,this.canvasFormat),this.skyboxRenderer.addSkybox(e),this.skyboxRenderer.setActiveSkybox(e);const t=await v.from(["headers","vertex","fragment","complexNumber","random"],"Render Shader Module");t.initialise(this.device),this.cameraBuffer=this.device.createBuffer({label:"Camera Buffer",size:C.BYTE_SIZE,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.renderSettingsBuffer=this.device.createBuffer({label:"Settings Buffer",size:6*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.device.queue.writeBuffer(this.renderSettingsBuffer,0,new Float32Array([0,50,256,2e3])),this.depthTexture=this.createDepthTexture();const i=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT},{binding:1,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:3,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:4,storageTexture:{format:"rgba32float",access:"read-only"},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:i,entries:[{binding:0,resource:{buffer:this.cameraBuffer}},{binding:1,resource:{buffer:this.renderSettingsBuffer}},{binding:2,resource:this.skyboxRenderer.sampler},{binding:3,resource:this.skyboxRenderer.skyboxes[0].texture.createView({dimension:"cube"})},{binding:4,resource:this.waveHeightMap.heightMap.createView()}]});const s=this.device.createPipelineLayout({label:"Render Pipeline Layout",bindGroupLayouts:[i]});this.renderPipeline=this.device.createRenderPipeline({label:"Render Pipeline",layout:s,vertex:{module:t.shaderModule,entryPoint:"vertexMain",buffers:[te]},fragment:{module:t.shaderModule,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{topology:this.settings.wireframe?"line-list":"triangle-list",cullMode:"front"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),this.initialised=!0}createDepthTexture(){return this.device.createTexture({size:this.canvas,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}render(e,t,i){if(!this.initialised){console.error("Renderer not initialised");return}this.waveHeightMap.create(i),e.aspectRatio=this.canvas.width/this.canvas.height,this.device.queue.writeBuffer(this.cameraBuffer,0,e.writeToBuffer()),this.device.queue.writeBuffer(this.renderSettingsBuffer,0,new Float32Array([i]));const s=this.device.createCommandEncoder({label:"Render Command Encoder"}),n=s.beginRenderPass({label:"Render Pass",colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});n.setBindGroup(0,this.renderBindGroup),n.setPipeline(this.renderPipeline);for(const r of t)try{r.render(n,e)}catch(o){console.error("Error while trying to render object",o)}this.skyboxRenderer.render(n,e),n.end(),this.device.queue.submit([s.finish()])}static async create(e,t={}){if(!navigator.gpu)throw new Error("WebGPU not supported");const i=await navigator.gpu.requestAdapter();if(i===null)throw new Error("No GPU Adapter found");const s=await i.requestDevice();return new F(s,e,t)}}class ie{callbacks;animationFrameID;lastTick;constructor(){this.callbacks=[],this.animationFrameID=null,this.lastTick=0}start(){this.animationFrameID!==null&&cancelAnimationFrame(this.animationFrameID),this.tick(0)}stop(){this.animationFrameID!==null&&(cancelAnimationFrame(this.animationFrameID),this.animationFrameID=null)}tick(e){const i={deltaTimeMS:e-this.lastTick,totalTimeMS:e};for(const s of this.callbacks)s(i);this.lastTick=e,this.animationFrameID=requestAnimationFrame(s=>this.tick.bind(this)(s))}addCallback(e){this.callbacks.push(e)}removeCallback(e){const t=this.callbacks.findIndex(i=>i===e);if(t===-1){console.warn("Callback not found");return}this.callbacks.splice(t,1)}}function se(c,e){const t=e/c,s=-.09784735812133072-.5*(1-1/c)*e,n=[],r=[],o=(c+1)**2;for(let a=0;a<o;a++){const u=Math.floor(a/(c+1)),m=a-(c+1)*u;n.push(s+m*t,0,s+u*t)}for(let a=0;a<c;a++)for(let u=0;u<c;u++){const m=u*(c+1),b=(u+1)*(c+1);r.push(m+a+1,b+a+1,b+a),r.push(m+a,m+a+1,b+a)}return{vertices:n,indices:r}}const q=document.querySelector(".loading");ne().then(()=>{q.remove()}).catch(c=>{throw q.textContent=c instanceof Error?c.message:typeof c=="string"?c:JSON.stringify(c),alert(c),c});async function ne(){const c=document.querySelector("canvas");if(c===null)throw new Error("Could not find canvas");c.addEventListener("click",()=>{c.requestPointerLock()});const e=await F.create(c,{wireframe:!1});await e.initialise();const t=new C({position:new P(0,.5,5),movementSpeed:.1}),i=se(511,50),s=new j(i.vertices,i.indices,"Ocean Mesh"),n=new ie;s.initialise(e.device);const r=o=>{const a=o.totalTimeMS/1e3;t.checkKeyboardInputs(),e.render(t,[s],a)};n.addCallback(r),n.start()}
