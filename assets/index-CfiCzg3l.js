(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const I=Math.PI/180;function D(m){return m*I}function V(m,t,e){return Math.max(Math.min(m,e),t)}class z{keybinds;eventListeners;keysDown;constructor(t){this.eventListeners=[],this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){if(this.eventListeners.length>0)return;const t={callback:this.onKeyDown.bind(this)},e={callback:this.onKeyUp.bind(this)};document.addEventListener("keydown",t.callback),document.addEventListener("keyup",e.callback)}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}removeEventListeners(){for(const{type:t,callback:e}of this.eventListeners)document.removeEventListener(t,e)}}class M{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this.components[4]=t.components[4],this.components[5]=t.components[5],this.components[6]=t.components[6],this.components[7]=t.components[7],this.components[8]=t.components[8],this.components[9]=t.components[9],this.components[10]=t.components[10],this.components[11]=t.components[11],this.components[12]=t.components[12],this.components[13]=t.components[13],this.components[14]=t.components[14],this.components[15]=t.components[15],this}preMultiply(t){return M.multiply(t,this,this),this}postMultiply(t){return M.multiply(this,t,this),this}static multiply(t,e,n=new M){const s=t.components[0],i=t.components[1],o=t.components[2],r=t.components[3],a=t.components[4],u=t.components[5],g=t.components[6],b=t.components[7],w=t.components[8],y=t.components[9],v=t.components[10],c=t.components[11],k=t.components[12],B=t.components[13],E=t.components[14],S=t.components[15];let h=e.components[0],p=e.components[1],l=e.components[2],d=e.components[3];return n.components[0]=h*s+p*a+l*w+d*k,n.components[1]=h*i+p*u+l*y+d*B,n.components[2]=h*o+p*g+l*v+d*E,n.components[3]=h*r+p*b+l*c+d*S,h=e.components[4],p=e.components[5],l=e.components[6],d=e.components[7],n.components[4]=h*s+p*a+l*w+d*k,n.components[5]=h*i+p*u+l*y+d*B,n.components[6]=h*o+p*g+l*v+d*E,n.components[7]=h*r+p*b+l*c+d*S,h=e.components[8],p=e.components[9],l=e.components[10],d=e.components[11],n.components[8]=h*s+p*a+l*w+d*k,n.components[9]=h*i+p*u+l*y+d*B,n.components[10]=h*o+p*g+l*v+d*E,n.components[11]=h*r+p*b+l*c+d*S,h=e.components[12],p=e.components[13],l=e.components[14],d=e.components[15],n.components[12]=h*s+p*a+l*w+d*k,n.components[13]=h*i+p*u+l*y+d*B,n.components[14]=h*o+p*g+l*v+d*E,n.components[15]=h*r+p*b+l*c+d*S,n}static perspective(t,e,n,s){const i=new M,o=1/Math.tan(t/2);if(i.components[0]=o/e,i.components[5]=o,i.components[11]=-1,i.components[15]=0,s!==1/0){const r=1/(n-s);i.components[10]=s*r,i.components[14]=s*n*r}else i.components[10]=-1,i.components[14]=-n;return i}static lookAt(t,e,n){const s=new M,i=1e-6;let o,r,a,u,g,b,w,y,v,c;const k=t.x,B=t.y,E=t.z,S=n.x,h=n.y,p=n.z,l=e.x,d=e.y,U=e.z;return Math.abs(k-l)<i&&Math.abs(B-d)<i&&Math.abs(E-U)<i?(console.warn("Look At too close to Position"),new M):(w=k-l,y=B-d,v=E-U,c=1/Math.sqrt(w*w+y*y+v*v),w*=c,y*=c,v*=c,o=h*v-p*y,r=p*w-S*v,a=S*y-h*w,c=Math.sqrt(o*o+r*r+a*a),c?(c=1/c,o*=c,r*=c,a*=c):(o=0,r=0,a=0),u=y*a-v*r,g=v*o-w*a,b=w*r-y*o,c=Math.sqrt(u*u+g*g+b*b),c?(c=1/c,u*=c,g*=c,b*=c):(u=0,g=0,b=0),s.components[0]=o,s.components[1]=u,s.components[2]=w,s.components[3]=0,s.components[4]=r,s.components[5]=g,s.components[6]=y,s.components[7]=0,s.components[8]=a,s.components[9]=b,s.components[10]=v,s.components[11]=0,s.components[12]=-(o*k+r*B+a*E),s.components[13]=-(u*k+g*B+b*E),s.components[14]=-(w*k+y*B+v*E),s.components[15]=1,s)}}class f{static ZERO=new f;components;constructor(t=0,e=0,n=0){this.components=new Float32Array(3),this.components[0]=t,this.components[1]=e,this.components[2]=n}*[Symbol.iterator](){yield this.components[0],yield this.components[1],yield this.components[2]}static scale(t,e){return new f(t.components[0]*e,t.components[1]*e,t.components[2]*e)}static add(t,e){return t.clone().add(e)}static subtract(t,e){return t.clone().subtract(e)}static cross(t,e){const n=t.components[0],s=t.components[1],i=t.components[2],o=e.components[0],r=e.components[1],a=e.components[2];return new f(s*a-i*r,i*o-n*a,n*r-s*o)}add(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this}subtract(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this}multiply(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this.components[2]*=t.components[2],this}scale(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}normalise(){const t=1/this.magnitude;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}clone(){return new f(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class K{position;fieldOfView;aspectRatio;near;far;movementSpeed;mouseSensitivity;keybinds;forward;up;pitch;yaw;keyboardManager;constructor(t={}){this.position=t.position??new f,this.fieldOfView=t.fieldOfView??60,this.aspectRatio=t.aspectRatio??16/9,this.near=t.near??.001,this.far=t.far??1e3,this.movementSpeed=t.movementSpeed??.05,this.mouseSensitivity=t.mouseSensitivity??.1,this.forward=new f(0,0,-1),this.up=new f(0,1,0),this.pitch=0,this.yaw=-90,this.keybinds={forwards:t.keybinds?.forwards??"KeyW",backwards:t.keybinds?.backwards??"KeyS",left:t.keybinds?.left??"KeyA",right:t.keybinds?.right??"KeyD",up:t.keybinds?.up??"Space",down:t.keybinds?.down??"ShiftLeft"},this.keyboardManager=new z(Object.values(this.keybinds)),this.addEventListeners()}getPerspectiveMatrix(){return M.perspective(D(this.fieldOfView),this.aspectRatio,this.near,this.far)}getViewMatrix(){return M.lookAt(this.position,f.add(this.position,this.forward),this.up)}getPerspectiveViewMatrix(){return this.getPerspectiveMatrix().postMultiply(this.getViewMatrix())}checkKeyboardInputs(){if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const t=this.forward.clone();t.y=0,this.position.add(f.scale(t.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const t=this.forward.clone();t.y=0,this.position.subtract(f.scale(t.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const t=this.forward.clone();t.y=0,this.position.subtract(f.scale(f.cross(t,this.up).normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const t=this.forward.clone();t.y=0,this.position.add(f.scale(f.cross(t,this.up).normalise(),this.movementSpeed))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=this.movementSpeed),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=this.movementSpeed)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",t=>{const e=t.movementX*this.mouseSensitivity,n=-t.movementY*this.mouseSensitivity;this.yaw+=e,this.pitch=V(-89,this.pitch+n,89);const s=D(this.yaw),i=D(this.pitch),o=Math.cos(s),r=Math.cos(i),a=Math.sin(s),u=Math.sin(i),g=new f(o*r,u,a*r).normalise();this.forward=g})}}class q{constructor(t,e=""){this.vertices=t,this.label=e,this.initialised=!1}vertexBuffer;initialised;initialise(t){if(this.initialised)return;const e=new Float32Array(this.vertices);this.vertexBuffer=t.createBuffer({label:this.label,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.vertexBuffer,0,e),this.initialised=!0}get verticeCount(){return this.vertices.length/3}}class Y extends M{constructor(t){super(),this.label=t,this.initialised=!1}device;buffer;initialised;initialise(t,e=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){if(this.initialised){console.warn("Matrix4Buffer already initialised");return}this.buffer=t.createBuffer({label:this.label,size:64,usage:e}),this.device=t,this.initialised=!0}writeBuffer(){if(!this.initialised){console.error("Matrix4Buffer not initialised");return}this.device.queue.writeBuffer(this.buffer,0,this.components)}}class P{constructor(t,e){this.code=t,this.label=e,this.initialised=!1}static BASE_PATH="/Ocean-Simulation/shaders";initialised;shaderModule;static async from(t,e){const s=(typeof t=="string"?[t]:t).map(o=>fetch(P.resolveBasePath(o)).then(r=>r.text())),i=(await Promise.all(s)).join("");return new P(i,e)}static resolveBasePath(t){return P.BASE_PATH===""?t:`${P.BASE_PATH}/${t}.wgsl`}initialise(t){if(this.initialised){console.warn("Shader already initialised");return}const e=t.createShaderModule({label:this.label,code:this.code});this.shaderModule=e,this.initialised=!0}}function T(m,t){return(t-m)*Math.random()+m}const N=Math.PI*2;class L{components;constructor(t=0,e=0){this.components=new Float32Array(2),this.components[0]=t,this.components[1]=e}normalise(){const t=1/this.magnitude;return this.components[0]*=t,this.components[1]*=t,this}get x(){return this.components[0]}get y(){return this.components[1]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}get magnitude(){return Math.hypot(this.components[0],this.components[1])}static randomUnit(){const t=T(0,N),e=Math.cos(t),n=Math.sin(t);return new L(e,n).normalise()}}const R=Math.PI*2;class x{constructor(t,e,n,s){this.wavelength=t,this.speed=e,this.amplitude=n,this.direction=s}static BYTE_SIZE=8*Float32Array.BYTES_PER_ELEMENT;writeToBuffer(t){t.writeFloat32(this.frequency),t.writeFloat32(this.amplitude),t.writeFloat32(this.phaseConstant),t.pad(4),t.writeVec2f32(this.direction),t.pad(8)}get frequency(){return R/this.wavelength}get phaseConstant(){return this.speed*R/this.wavelength}static random(){const t=T(.5,1.5),e=T(.4,.6),n=T(.1,.3),s=L.randomUnit();return new x(t,e,n,s)}}class W{constructor(t=new ArrayBuffer,e=!0,n=0){this.littleEndian=e,this.offset=n,this.buffer=t instanceof ArrayBuffer?t:new ArrayBuffer(t),this.dataview=new DataView(this.buffer)}buffer;dataview;toFloat32Array(){return new Float32Array(this.buffer)}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeVec2f32(t){this.writeFloat32(t.x),this.writeFloat32(t.y)}writeVec3f32(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeBooleanAsUint32(t){this.writeUint32(t?1:0)}pad(t){for(let e=0;e<t;e++)this.dataview.setUint8(this.offset,0),this.offset+=1}}const X={arrayStride:Float32Array.BYTES_PER_ELEMENT*3,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class F{constructor(t,e,n){this.device=t,this.canvas=e;const s=this.canvas.getContext("webgpu");if(s===null)throw new Error("Could not get WebGPU Canvas context");this.ctx=s,this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),this.initialised=!1;const i=Object.assign(structuredClone(F.DEFAULT_SETTINGS),n);this.settings=i,this.perspectiveViewMatrix=new Y("Perspective Matrix"),this.perspectiveViewMatrix.initialise(t),new ResizeObserver(o=>{const r=o[0],a=r.devicePixelContentBoxSize[0].inlineSize,u=r.devicePixelContentBoxSize[0].blockSize;this.canvas.width=a,this.canvas.height=u,this.depthTexture=this.createDepthTexture()}).observe(this.canvas)}static DEFAULT_SETTINGS={wireframe:!1,waves:32};settings;ctx;canvasFormat;initialised;renderBindGroup;renderPipeline;depthTexture;perspectiveViewMatrix;settingsBuffer;wavesBuffer;async initialise(){if(this.initialised)return;this.ctx.configure({device:this.device,format:this.canvasFormat});const t=await P.from(["headers","vertex","fragment","waveFunctions"],"Render Shader Module");t.initialise(this.device),this.settingsBuffer=this.device.createBuffer({label:"Settings Buffer",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.wavesBuffer=this.device.createBuffer({label:"Waves Buffer",size:this.settings.waves*x.BYTE_SIZE,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const e=new W(this.settings.waves*x.BYTE_SIZE),n=Array.from(Array(this.settings.waves),()=>x.random());for(const o of n)o.writeToBuffer(e);this.device.queue.writeBuffer(this.wavesBuffer,0,e.toFloat32Array()),this.depthTexture=this.createDepthTexture();const s=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:2,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:s,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrix.buffer}},{binding:1,resource:{buffer:this.settingsBuffer}},{binding:2,resource:{buffer:this.wavesBuffer}}]});const i=this.device.createPipelineLayout({label:"Render Pipeline Layout",bindGroupLayouts:[s]});this.renderPipeline=this.device.createRenderPipeline({label:"Render Pipeline",layout:i,vertex:{module:t.shaderModule,entryPoint:"vertexMain",buffers:[X]},fragment:{module:t.shaderModule,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{topology:this.settings.wireframe?"line-strip":"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),this.initialised=!0}createDepthTexture(){return this.device.createTexture({size:{width:this.canvas.width,height:this.canvas.height},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}render(t,e,n){if(!this.initialised){console.error("Renderer not initialised");return}e.initialise(this.device),t.aspectRatio=this.canvas.width/this.canvas.height,this.perspectiveViewMatrix.copyFrom(t.getPerspectiveViewMatrix()).writeBuffer(),this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([n]));const s=this.device.createCommandEncoder({label:"Render Command Encoder"}),i=s.beginRenderPass({label:"Render Pass",colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});i.setViewport(0,0,this.canvas.width,this.canvas.height,0,1),i.setVertexBuffer(0,e.vertexBuffer),i.setBindGroup(0,this.renderBindGroup),i.setPipeline(this.renderPipeline),i.draw(e.verticeCount),i.end(),this.device.queue.submit([s.finish()])}static async create(t,e={}){if(!navigator.gpu)throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(n===null)throw new Error("No GPU Adapter found");const s=await n.requestDevice();return new F(s,t,e)}}class Z{callbacks;animationFrameID;lastTick;constructor(){this.callbacks=[],this.animationFrameID=null,this.lastTick=0}start(){this.animationFrameID!==null&&cancelAnimationFrame(this.animationFrameID),this.tick(0)}stop(){this.animationFrameID!==null&&(cancelAnimationFrame(this.animationFrameID),this.animationFrameID=null)}tick(t){const n={deltaTimeMS:t-this.lastTick,totalTimeMS:t};for(const s of this.callbacks)s(n);this.lastTick=t,this.animationFrameID=requestAnimationFrame(s=>this.tick.bind(this)(s))}addCallback(t){this.callbacks.push(t)}removeCallback(t){const e=this.callbacks.findIndex(n=>n===t);if(e===-1){console.warn("Callback not found");return}this.callbacks.splice(e,1)}}const A=document.querySelector("canvas");if(A===null)throw new Error("Could not find canvas");A.addEventListener("click",()=>{A.requestPointerLock()});const C=await F.create(A,{wireframe:!1});await C.initialise();const G=new K({position:new f(0,1,5)}),_=new q(H(500,10),"Square"),O=new Z,j=m=>{const t=m.totalTimeMS/1e3;G.checkKeyboardInputs(),C.render(G,_,t)};O.addCallback(j);O.start();function H(m,t){const e=t/m/2,n=.5*(1-1/m)*t,s=[e-n,0,-.01-n,e-n,0,e-n,-.01-n,0,e-n,-.01-n,0,-.01-n,e-n,0,-.01-n,-.01-n,0,e-n],i=[];for(let o=0;o<m;o++)for(let r=0;r<m;r++)for(let a=0;a<s.length;a++){const u=s[a];switch(a%3){case 0:i.push(u+o*e*2);break;case 1:i.push(u);break;case 2:i.push(u+r*e*2);break}}return i}
