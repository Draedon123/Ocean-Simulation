(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Y=Math.PI/180;function C(c){return c*Y}class N{constructor(e=new ArrayBuffer,t=!0,n=0){this.littleEndian=t,this.offset=n,this.buffer=e instanceof ArrayBuffer?e:new ArrayBuffer(e),this.dataview=new DataView(this.buffer)}buffer;dataview;toFloat32Array(){return new Float32Array(this.buffer)}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeVec2f32(e){this.writeFloat32(e.x),this.writeFloat32(e.y)}writeVec3f32(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}writeBooleanAsUint32(e){this.writeUint32(e?1:0)}pad(e){for(let t=0;t<e;t++)this.dataview.setUint8(this.offset,0),this.offset+=1}}function q(c,e,t){return Math.max(Math.min(c,t),e)}class K{keybinds;eventListeners;keysDown;constructor(e){this.eventListeners=[],this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){if(this.eventListeners.length>0)return;const e={callback:this.onKeyDown.bind(this)},t={callback:this.onKeyUp.bind(this)};document.addEventListener("keydown",e.callback),document.addEventListener("keyup",t.callback)}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}removeEventListeners(){for(const{type:e,callback:t}of this.eventListeners)document.removeEventListener(e,t)}}class M{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],n=this.components[2],s=this.components[3],i=this.components[4],o=this.components[5],r=this.components[6],a=this.components[7],h=this.components[8],f=this.components[9],y=this.components[10],b=this.components[11],w=this.components[12],g=this.components[13],d=this.components[14],v=this.components[15],S=e*o-t*i,k=e*r-n*i,E=e*a-s*i,l=t*r-n*o,p=t*a-s*o,u=n*a-s*r,m=h*g-f*w,P=h*d-y*w,T=h*v-b*w,R=f*d-y*g,G=f*v-b*g,U=y*v-b*d,O=S*U-k*G+E*R+l*T-p*P+u*m;if(O===0)return console.warn("Determinant is 0. Matrix not inverted"),this;const B=1/O;return this.components[0]=(o*U-r*G+a*R)*B,this.components[1]=(n*G-t*U-s*R)*B,this.components[2]=(g*u-d*p+v*l)*B,this.components[3]=(y*p-f*u-b*l)*B,this.components[4]=(r*T-i*U-a*P)*B,this.components[5]=(e*U-n*T+s*P)*B,this.components[6]=(d*E-w*u-v*k)*B,this.components[7]=(h*u-y*E+b*k)*B,this.components[8]=(i*G-o*T+a*m)*B,this.components[9]=(t*T-e*G-s*m)*B,this.components[10]=(w*p-g*E+v*S)*B,this.components[11]=(f*E-h*p-b*S)*B,this.components[12]=(o*P-i*R-r*m)*B,this.components[13]=(e*R-t*P+n*m)*B,this.components[14]=(g*k-w*l-d*S)*B,this.components[15]=(h*l-f*k+y*S)*B,this}preMultiply(e){return M.multiply(e,this,this),this}postMultiply(e){return M.multiply(this,e,this),this}static multiply(e,t,n=new M){const s=e.components[0],i=e.components[1],o=e.components[2],r=e.components[3],a=e.components[4],h=e.components[5],f=e.components[6],y=e.components[7],b=e.components[8],w=e.components[9],g=e.components[10],d=e.components[11],v=e.components[12],S=e.components[13],k=e.components[14],E=e.components[15];let l=t.components[0],p=t.components[1],u=t.components[2],m=t.components[3];return n.components[0]=l*s+p*a+u*b+m*v,n.components[1]=l*i+p*h+u*w+m*S,n.components[2]=l*o+p*f+u*g+m*k,n.components[3]=l*r+p*y+u*d+m*E,l=t.components[4],p=t.components[5],u=t.components[6],m=t.components[7],n.components[4]=l*s+p*a+u*b+m*v,n.components[5]=l*i+p*h+u*w+m*S,n.components[6]=l*o+p*f+u*g+m*k,n.components[7]=l*r+p*y+u*d+m*E,l=t.components[8],p=t.components[9],u=t.components[10],m=t.components[11],n.components[8]=l*s+p*a+u*b+m*v,n.components[9]=l*i+p*h+u*w+m*S,n.components[10]=l*o+p*f+u*g+m*k,n.components[11]=l*r+p*y+u*d+m*E,l=t.components[12],p=t.components[13],u=t.components[14],m=t.components[15],n.components[12]=l*s+p*a+u*b+m*v,n.components[13]=l*i+p*h+u*w+m*S,n.components[14]=l*o+p*f+u*g+m*k,n.components[15]=l*r+p*y+u*d+m*E,n}static perspective(e,t,n,s){const i=new M,o=1/Math.tan(e/2);if(i.components[0]=o/t,i.components[5]=o,i.components[11]=-1,i.components[15]=0,s!==1/0){const r=1/(n-s);i.components[10]=s*r,i.components[14]=s*n*r}else i.components[10]=-1,i.components[14]=-n;return i}static lookAt(e,t,n){const s=new M,i=1e-6;let o,r,a,h,f,y,b,w,g,d;const v=e.x,S=e.y,k=e.z,E=n.x,l=n.y,p=n.z,u=t.x,m=t.y,P=t.z;return Math.abs(v-u)<i&&Math.abs(S-m)<i&&Math.abs(k-P)<i?(console.warn("Look At too close to Position"),new M):(b=v-u,w=S-m,g=k-P,d=1/Math.sqrt(b*b+w*w+g*g),b*=d,w*=d,g*=d,o=l*g-p*w,r=p*b-E*g,a=E*w-l*b,d=Math.sqrt(o*o+r*r+a*a),d?(d=1/d,o*=d,r*=d,a*=d):(o=0,r=0,a=0),h=w*a-g*r,f=g*o-b*a,y=b*r-w*o,d=Math.sqrt(h*h+f*f+y*y),d?(d=1/d,h*=d,f*=d,y*=d):(h=0,f=0,y=0),s.components[0]=o,s.components[1]=h,s.components[2]=b,s.components[3]=0,s.components[4]=r,s.components[5]=f,s.components[6]=w,s.components[7]=0,s.components[8]=a,s.components[9]=y,s.components[10]=g,s.components[11]=0,s.components[12]=-(o*v+r*S+a*k),s.components[13]=-(h*v+f*S+y*k),s.components[14]=-(b*v+w*S+g*k),s.components[15]=1,s)}}class x{static ZERO=new x;components;constructor(e=0,t=0,n=0){this.components=new Float32Array(3),this.components[0]=e,this.components[1]=t,this.components[2]=n}*[Symbol.iterator](){yield this.components[0],yield this.components[1],yield this.components[2]}static scale(e,t){return new x(e.components[0]*t,e.components[1]*t,e.components[2]*t)}static add(e,t){return e.clone().add(t)}static subtract(e,t){return e.clone().subtract(t)}static cross(e,t){const n=e.components[0],s=e.components[1],i=e.components[2],o=t.components[0],r=t.components[1],a=t.components[2];return new x(s*a-i*r,i*o-n*a,n*r-s*o)}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}multiply(e){return this.components[0]*=e.components[0],this.components[1]*=e.components[1],this.components[2]*=e.components[2],this}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}normalise(){const e=1/this.magnitude;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}clone(){return new x(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class L{static BYTE_SIZE=32*Float32Array.BYTES_PER_ELEMENT;position;fieldOfView;aspectRatio;near;far;movementSpeed;mouseSensitivity;keybinds;forward;up;pitch;yaw;keyboardManager;constructor(e={}){this.position=e.position??new x,this.fieldOfView=e.fieldOfView??60,this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.001,this.far=e.far??1e3,this.movementSpeed=e.movementSpeed??.05,this.mouseSensitivity=e.mouseSensitivity??.1,this.forward=new x(0,0,-1),this.up=new x(0,1,0),this.pitch=0,this.yaw=-90,this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new K(Object.values(this.keybinds)),this.addEventListeners()}getPerspectiveMatrix(){return M.perspective(C(this.fieldOfView),this.aspectRatio,this.near,this.far)}getViewMatrix(){return M.lookAt(this.position,x.add(this.position,this.forward),this.up)}getPerspectiveViewMatrix(){return this.getPerspectiveMatrix().postMultiply(this.getViewMatrix())}writeToBuffer(){const e=new N(L.BYTE_SIZE);return e.writeMat4x4f(this.getPerspectiveViewMatrix()),e.writeVec3f32(this.position),e.pad(4),e.writeVec3f32(this.forward.normalise()),e.toFloat32Array()}checkKeyboardInputs(){if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const e=this.forward.clone();e.y=0,this.position.add(x.scale(e.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const e=this.forward.clone();e.y=0,this.position.subtract(x.scale(e.normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const e=this.forward.clone();e.y=0,this.position.subtract(x.scale(x.cross(e,this.up).normalise(),this.movementSpeed))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const e=this.forward.clone();e.y=0,this.position.add(x.scale(x.cross(e,this.up).normalise(),this.movementSpeed))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=this.movementSpeed),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=this.movementSpeed)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,n=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=q(this.pitch+n,-89,89);const s=C(this.yaw),i=C(this.pitch),o=Math.cos(s),r=Math.cos(i),a=Math.sin(s),h=Math.sin(i),f=new x(o*r,h,a*r).normalise();this.forward=f})}}class ${constructor(e,t,n=""){this.vertices=e,this.indices=t,this.label=n,this.initialised=!1}vertexBuffer;indexBuffer;initialised;initialise(e){if(this.initialised)return;const t=new Float32Array(this.vertices),n=new(this.indexFormat==="uint16"?Uint16Array:Uint32Array)(this.indices);this.vertexBuffer=e.createBuffer({label:`${this.label} Vertex Buffer`,size:t.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.indexBuffer=e.createBuffer({label:`${this.label} Index Buffer`,size:n.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.vertexBuffer,0,t),e.queue.writeBuffer(this.indexBuffer,0,n),this.initialised=!0}render(e){if(!this.initialised){console.error(`Mesh ${this.label} not initialised`);return}this.bind(e),e.drawIndexed(this.indexCount)}bind(e){if(!this.initialised){console.error(`Mesh ${this.label} not initialised`);return}e.setVertexBuffer(0,this.vertexBuffer),e.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.vertices.length/3}get indexCount(){return this.indices.length}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}function z(c){return`/Ocean-Simulation/${c}`}class I{constructor(e,t){this.code=e,this.label=t,this.initialised=!1}initialised;shaderModule;static async from(e,t){const s=(typeof e=="string"?[e]:e).map(o=>fetch(z(`shaders/${o}.wgsl`)).then(r=>r.text())),i=(await Promise.all(s)).join("");return new I(i,t)}initialise(e){if(this.initialised){console.warn("Shader already initialised");return}const t=e.createShaderModule({label:this.label,code:this.code});this.shaderModule=t,this.initialised=!0}}function A(c,e){return Array.isArray(c)?A(c[0],c[1]):(e-c)*Math.random()+c}const _=Math.PI*2;class V{components;constructor(e=0,t=0){this.components=new Float32Array(2),this.components[0]=e,this.components[1]=t}normalise(){const e=1/this.magnitude;return this.components[0]*=e,this.components[1]*=e,this}get x(){return this.components[0]}get y(){return this.components[1]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}get magnitude(){return Math.hypot(this.components[0],this.components[1])}static randomUnit(){const e=A(0,_),t=Math.cos(e),n=Math.sin(e);return new V(t,n).normalise()}}class F{constructor(e,t){this.speed=e,this.direction=t}static BYTE_SIZE=3*Float32Array.BYTES_PER_ELEMENT;writeToBuffer(e){e.writeVec2f32(this.direction),e.writeFloat32(this.speed)}static random(e){const t=A(e.speed),n=V.randomUnit();return new F(t,n)}}class X{constructor(e=""){this.label=e,this.initialised=!1}initialised;texture;async initialise(e,...t){if(this.initialised)return;const n=t.map(async o=>await(await fetch(z(o))).blob()),s=await Promise.all(n),i=await Promise.all(s.map(o=>createImageBitmap(o)));this.texture=e.createTexture({label:this.label,format:"rgba8unorm",size:[i[0].width,i[0].height,i.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let o=0;o<i.length;o++){const r=i[o];e.queue.copyExternalImageToTexture({source:r},{texture:this.texture,origin:[0,0,o]},{width:r.width,height:r.height})}this.initialised=!0}}class W extends X{async initialise(e,...t){if(t.length!==6)throw new Error("Exactly 6 textures needed for Cubemap");for(const n of t){const s=n.split("/").at(-1)?.split(".").slice(0,-1).join("")??"";if(!/^[np][xyz]$/.test(s))throw new Error(`Invalid url ${n}. File name must be in the format of (n or p)(x, y, or z)`)}await super.initialise(e,...t)}}class Z extends M{constructor(e){super(),this.label=e,this.initialised=!1}device;buffer;initialised;initialise(e,t=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){if(this.initialised){console.warn("Matrix4Buffer already initialised");return}this.buffer=e.createBuffer({label:this.label,size:64,usage:t}),this.device=e,this.initialised=!0}writeBuffer(){if(!this.initialised){console.error("Matrix4Buffer not initialised");return}this.device.queue.writeBuffer(this.buffer,0,this.components)}}class j{constructor(e="",...t){this.label=e,this.activeSkybox=t.length-1,this.skyboxes=t,this.bindGroups=[],this.inversePespectiveViewMatrix=new Z(`Skybox ${this.label} Inverse Perspective View Matrix Butter`),this.initialised=!1}initialised;inversePespectiveViewMatrix;bindGroups=[];activeSkybox;device;renderBindGroupLayout;renderPipeline;skyboxes;sampler;async initialise(e,t){if(this.initialised)return;this.device=e,this.sampler=e.createSampler({label:`Skybox Renderer ${this.label} Sampler`}),this.inversePespectiveViewMatrix.initialise(e);const n=await I.from("skybox",`Skybox Renderer "${this.label}" Shader Module`);n.initialise(e),this.renderBindGroupLayout=e.createBindGroupLayout({label:`Skybox Renderer "${this.label}" Bind Group Layout`,entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const s=e.createPipelineLayout({label:`Skybox Renderer "${this.label}" Render Pipeline Layout`,bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=e.createRenderPipeline({label:`Skybox Renderer "${this.label}" Render Pipeline`,layout:s,vertex:{module:n.shaderModule,entryPoint:"vertexMain"},fragment:{module:n.shaderModule,entryPoint:"fragmentMain",targets:[{format:t}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}});for(let i=0,o=this.skyboxes.length;i<o;i++){const r=this.skyboxes[i];this.skyboxes.splice(0,1),this.addSkybox(r)}this.initialised=!0}addSkybox(e){const t=this.device.createBindGroup({label:`Skybox Renderer "${e.label}" Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix.buffer}}]});this.skyboxes.push(e),this.bindGroups.push(t)}setActiveSkybox(e){if(e===null){this.activeSkybox=-1;return}this.skyboxes.includes(e)||this.addSkybox(e);const t=this.skyboxes.findIndex(n=>n===e);this.activeSkybox=t}render(e,t){if(!this.initialised){console.error(`Skybox Renderer "${this.label}" not initialised`);return}if(this.activeSkybox===-1){console.warn("No active skybox");return}this.inversePespectiveViewMatrix.copyFrom(t.getPerspectiveViewMatrix().invert()),this.inversePespectiveViewMatrix.writeBuffer(),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroups[this.activeSkybox]),e.draw(3)}}const H={arrayStride:Float32Array.BYTES_PER_ELEMENT*3,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class D{constructor(e,t,n){this.device=e,this.canvas=t;const s=this.canvas.getContext("webgpu");if(s===null)throw new Error("Could not get WebGPU Canvas context");this.ctx=s,this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),this.skyboxRenderer=new j("Renderer Skybox"),this.initialised=!1;const i=Object.assign(structuredClone(D.DEFAULT_SETTINGS),n);this.settings=i,new ResizeObserver(o=>{const r=o[0],a=r.devicePixelContentBoxSize[0].inlineSize,h=r.devicePixelContentBoxSize[0].blockSize;this.canvas.width=a,this.canvas.height=h,this.depthTexture=this.createDepthTexture()}).observe(this.canvas)}static DEFAULT_SETTINGS={wireframe:!1,waves:32,frequencyRange:[3,6],amplitudeRange:[.2,.4],speedRange:[.4,.6]};settings;canvasFormat;skyboxRenderer;ctx;initialised;renderBindGroup;renderPipeline;depthTexture;cameraBuffer;settingsBuffer;wavesBuffer;async initialise(){if(this.initialised)return;this.ctx.configure({device:this.device,format:this.canvasFormat});const e=new W("Cubemap");await e.initialise(this.device,"skybox/px.png","skybox/nx.png","skybox/py.png","skybox/ny.png","skybox/pz.png","skybox/nz.png"),await this.skyboxRenderer.initialise(this.device,this.canvasFormat),this.skyboxRenderer.addSkybox(e),this.skyboxRenderer.setActiveSkybox(e);const t=await I.from(["headers","vertex","fragment","waveFunctions"],"Render Shader Module");t.initialise(this.device),this.cameraBuffer=this.device.createBuffer({label:"Camera Buffer",size:L.BYTE_SIZE,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.settingsBuffer=this.device.createBuffer({label:"Settings Buffer",size:3*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.wavesBuffer=this.device.createBuffer({label:"Waves Buffer",size:this.settings.waves*F.BYTE_SIZE,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const n=new N(this.settings.waves*F.BYTE_SIZE),s=Array.from(Array(this.settings.waves),()=>F.random({speed:this.settings.speedRange}));for(const r of s)r.writeToBuffer(n);this.device.queue.writeBuffer(this.wavesBuffer,0,n.toFloat32Array()),this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([0,A(this.settings.frequencyRange),A(this.settings.amplitudeRange)])),this.depthTexture=this.createDepthTexture();const i=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT},{binding:1,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:2,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX},{binding:3,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:4,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:i,entries:[{binding:0,resource:{buffer:this.cameraBuffer}},{binding:1,resource:{buffer:this.settingsBuffer}},{binding:2,resource:{buffer:this.wavesBuffer}},{binding:3,resource:this.skyboxRenderer.sampler},{binding:4,resource:this.skyboxRenderer.skyboxes[0].texture.createView({dimension:"cube"})}]});const o=this.device.createPipelineLayout({label:"Render Pipeline Layout",bindGroupLayouts:[i]});this.renderPipeline=this.device.createRenderPipeline({label:"Render Pipeline",layout:o,vertex:{module:t.shaderModule,entryPoint:"vertexMain",buffers:[H]},fragment:{module:t.shaderModule,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{topology:this.settings.wireframe?"line-strip":"triangle-list",cullMode:"front"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),this.initialised=!0}createDepthTexture(){return this.device.createTexture({size:this.canvas,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}render(e,t,n){if(!this.initialised){console.error("Renderer not initialised");return}e.aspectRatio=this.canvas.width/this.canvas.height,this.device.queue.writeBuffer(this.cameraBuffer,0,e.writeToBuffer()),this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([n]),0,1);const s=this.device.createCommandEncoder({label:"Render Command Encoder"}),i=s.beginRenderPass({label:"Render Pass",colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});i.setBindGroup(0,this.renderBindGroup),i.setPipeline(this.renderPipeline);for(const o of t)try{o.render(i,e)}catch(r){console.error("Error while trying to render object",r)}this.skyboxRenderer.render(i,e),i.end(),this.device.queue.submit([s.finish()])}static async create(e,t={}){if(!navigator.gpu)throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(n===null)throw new Error("No GPU Adapter found");const s=await n.requestDevice();return new D(s,e,t)}}class J{callbacks;animationFrameID;lastTick;constructor(){this.callbacks=[],this.animationFrameID=null,this.lastTick=0}start(){this.animationFrameID!==null&&cancelAnimationFrame(this.animationFrameID),this.tick(0)}stop(){this.animationFrameID!==null&&(cancelAnimationFrame(this.animationFrameID),this.animationFrameID=null)}tick(e){const n={deltaTimeMS:e-this.lastTick,totalTimeMS:e};for(const s of this.callbacks)s(n);this.lastTick=e,this.animationFrameID=requestAnimationFrame(s=>this.tick.bind(this)(s))}addCallback(e){this.callbacks.push(e)}removeCallback(e){const t=this.callbacks.findIndex(n=>n===e);if(t===-1){console.warn("Callback not found");return}this.callbacks.splice(t,1)}}function Q(c,e){const t=e/c/2,s=-.01-.5*(1-1/c)*e,i=[],o=[],r=(c+1)**2;for(let a=0;a<r;a++){const h=Math.floor(a/(c+1)),f=a-(c+1)*h;i.push(s+f*2*t,0,s+h*2*t)}for(let a=0;a<c;a++)for(let h=0;h<c;h++){const f=h*(c+1),y=(h+1)*(c+1);o.push(f+a+1,y+a+1,y+a),o.push(f+a,f+a+1,y+a)}return{vertices:i,indices:o}}ee().catch(c=>{throw alert(c),c});async function ee(){const c=document.querySelector("canvas");if(c===null)throw new Error("Could not find canvas");c.addEventListener("click",()=>{c.requestPointerLock()});const e=await D.create(c,{wireframe:!1,waves:32});await e.initialise();const t=new L({position:new x(0,.5,5)}),n=Q(500,10),s=new $(n.vertices,n.indices,"Ocean Mesh"),i=new J;s.initialise(e.device);const o=async r=>{const a=r.totalTimeMS/1e3;t.checkKeyboardInputs(),e.render(t,[s],a)};i.addCallback(o),i.start()}
