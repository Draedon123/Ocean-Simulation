(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const j=Math.PI/180;function _(u){return u*j}class Z{constructor(e=new ArrayBuffer,t=!0,i=0){this.littleEndian=t,this.offset=i,this.buffer=e instanceof ArrayBuffer?e:new ArrayBuffer(e),this.dataview=new DataView(this.buffer)}buffer;dataview;toFloat32Array(){return new Float32Array(this.buffer)}writeUint8(e){this.dataview.setUint8(this.offset,e),this.offset+=1}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeVec3f32(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}pad(e){for(let t=0;t<e;t++)this.writeUint8(0)}}function J(u,e,t){return Math.max(Math.min(u,t),e)}class Q{keybinds;keysDown;constructor(e){this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}}class M{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],i=this.components[2],s=this.components[3],n=this.components[4],r=this.components[5],o=this.components[6],a=this.components[7],c=this.components[8],l=this.components[9],p=this.components[10],b=this.components[11],y=this.components[12],w=this.components[13],h=this.components[14],x=this.components[15],P=e*r-t*n,S=e*o-i*n,T=e*a-s*n,d=t*o-i*r,m=t*a-s*r,f=i*a-s*o,g=c*w-l*y,F=c*h-p*y,A=c*x-b*y,R=l*h-p*w,C=l*x-b*w,L=p*x-b*h,H=P*L-S*C+T*R+d*A-m*F+f*g;if(H===0)return console.warn("Determinant is 0. Matrix not inverted"),this;const G=1/H;return this.components[0]=(r*L-o*C+a*R)*G,this.components[1]=(i*C-t*L-s*R)*G,this.components[2]=(w*f-h*m+x*d)*G,this.components[3]=(p*m-l*f-b*d)*G,this.components[4]=(o*A-n*L-a*F)*G,this.components[5]=(e*L-i*A+s*F)*G,this.components[6]=(h*T-y*f-x*S)*G,this.components[7]=(c*f-p*T+b*S)*G,this.components[8]=(n*C-r*A+a*g)*G,this.components[9]=(t*A-e*C-s*g)*G,this.components[10]=(y*m-w*T+x*P)*G,this.components[11]=(l*T-c*m-b*P)*G,this.components[12]=(r*F-n*R-o*g)*G,this.components[13]=(e*R-t*F+i*g)*G,this.components[14]=(w*S-y*d-h*P)*G,this.components[15]=(c*d-l*S+p*P)*G,this}postMultiply(e){return M.multiply(this,e,this),this}static multiply(e,t,i=new M){const s=e.components[0],n=e.components[1],r=e.components[2],o=e.components[3],a=e.components[4],c=e.components[5],l=e.components[6],p=e.components[7],b=e.components[8],y=e.components[9],w=e.components[10],h=e.components[11],x=e.components[12],P=e.components[13],S=e.components[14],T=e.components[15];let d=t.components[0],m=t.components[1],f=t.components[2],g=t.components[3];return i.components[0]=d*s+m*a+f*b+g*x,i.components[1]=d*n+m*c+f*y+g*P,i.components[2]=d*r+m*l+f*w+g*S,i.components[3]=d*o+m*p+f*h+g*T,d=t.components[4],m=t.components[5],f=t.components[6],g=t.components[7],i.components[4]=d*s+m*a+f*b+g*x,i.components[5]=d*n+m*c+f*y+g*P,i.components[6]=d*r+m*l+f*w+g*S,i.components[7]=d*o+m*p+f*h+g*T,d=t.components[8],m=t.components[9],f=t.components[10],g=t.components[11],i.components[8]=d*s+m*a+f*b+g*x,i.components[9]=d*n+m*c+f*y+g*P,i.components[10]=d*r+m*l+f*w+g*S,i.components[11]=d*o+m*p+f*h+g*T,d=t.components[12],m=t.components[13],f=t.components[14],g=t.components[15],i.components[12]=d*s+m*a+f*b+g*x,i.components[13]=d*n+m*c+f*y+g*P,i.components[14]=d*r+m*l+f*w+g*S,i.components[15]=d*o+m*p+f*h+g*T,i}static perspective(e,t,i,s){const n=new M,r=1/Math.tan(e/2);if(n.components[0]=r/t,n.components[5]=r,n.components[11]=-1,n.components[15]=0,s!==1/0){const o=1/(i-s);n.components[10]=s*o,n.components[14]=s*i*o}else n.components[10]=-1,n.components[14]=-i;return n}static lookAt(e,t,i){const s=new M,n=1e-6;let r,o,a,c,l,p,b,y,w,h;const x=e.x,P=e.y,S=e.z,T=i.x,d=i.y,m=i.z,f=t.x,g=t.y,F=t.z;return Math.abs(x-f)<n&&Math.abs(P-g)<n&&Math.abs(S-F)<n?(console.warn("Look At too close to Position"),new M):(b=x-f,y=P-g,w=S-F,h=1/Math.sqrt(b*b+y*y+w*w),b*=h,y*=h,w*=h,r=d*w-m*y,o=m*b-T*w,a=T*y-d*b,h=Math.sqrt(r*r+o*o+a*a),h?(h=1/h,r*=h,o*=h,a*=h):(r=0,o=0,a=0),c=y*a-w*o,l=w*r-b*a,p=b*o-y*r,h=Math.sqrt(c*c+l*l+p*p),h?(h=1/h,c*=h,l*=h,p*=h):(c=0,l=0,p=0),s.components[0]=r,s.components[1]=c,s.components[2]=b,s.components[3]=0,s.components[4]=o,s.components[5]=l,s.components[6]=y,s.components[7]=0,s.components[8]=a,s.components[9]=p,s.components[10]=w,s.components[11]=0,s.components[12]=-(r*x+o*P+a*S),s.components[13]=-(c*x+l*P+p*S),s.components[14]=-(b*x+y*P+w*S),s.components[15]=1,s)}}class v{components;constructor(e=0,t=0,i=0){this.components=new Float32Array(3),this.components[0]=e,this.components[1]=t,this.components[2]=i}static add(e,t){return e.clone().add(t)}static cross(e,t){const i=e.components[0],s=e.components[1],n=e.components[2],r=t.components[0],o=t.components[1],a=t.components[2];return new v(s*a-n*o,n*r-i*a,i*o-s*r)}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}normalise(){const e=1/this.magnitude;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}clone(){return new v(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class O{static BYTE_SIZE=32*Float32Array.BYTES_PER_ELEMENT;position;fieldOfView;aspectRatio;near;far;movementSpeed;mouseSensitivity;keybinds;forward;up;pitch;yaw;keyboardManager;constructor(e={}){this.position=e.position??new v,this.fieldOfView=e.fieldOfView??60,this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.001,this.far=e.far??1e3,this.movementSpeed=e.movementSpeed??.05,this.mouseSensitivity=e.mouseSensitivity??.1,this.forward=new v(0,0,-1),this.up=new v(0,1,0),this.pitch=e.pitch??0,this.yaw=e.yaw??0,this.updateForwardVector(),this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new Q(Object.values(this.keybinds)),this.addEventListeners()}getPerspectiveMatrix(){return M.perspective(_(this.fieldOfView),this.aspectRatio,this.near,this.far)}getViewMatrix(){return M.lookAt(this.position,v.add(this.position,this.forward),this.up)}getPerspectiveViewMatrix(){return this.getPerspectiveMatrix().postMultiply(this.getViewMatrix())}writeToBuffer(){const e=new Z(O.BYTE_SIZE);return e.writeMat4x4f(this.getPerspectiveViewMatrix()),e.writeVec3f32(this.position),e.pad(4),e.writeVec3f32(this.forward.normalise()),e.toFloat32Array()}checkKeyboardInputs(e){const t=this.movementSpeed*e;if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const i=this.forward.clone();i.y=0,this.position.add(i.normalise().scale(t))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const i=this.forward.clone();i.y=0,this.position.subtract(i.normalise().scale(t))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const i=this.forward.clone();i.y=0,this.position.subtract(v.cross(i,this.up).normalise().scale(t))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const i=this.forward.clone();i.y=0,this.position.add(v.cross(i,this.up).normalise().scale(t))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=t),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=t)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,i=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=J(this.pitch+i,-89,89),this.updateForwardVector()})}updateForwardVector(){const e=_(this.yaw),t=_(this.pitch),i=Math.cos(e),s=Math.cos(t),n=Math.sin(e),r=Math.sin(t),o=new v(i*s,r,n*s).normalise();this.forward=o}}function U(u,e,t,i){const s=u.createBuffer({label:e,usage:t,size:typeof i=="number"?i:i.byteLength});return typeof i!="number"&&u.queue.writeBuffer(s,0,i),s}class ee{constructor(e,t,i,s=""){this.label=s,this.vertices=new Float32Array(t),this.indices=new(this.indexFormat==="uint16"?Uint16Array:Uint32Array)(i),this.vertexBuffer=U(e,`${this.label} Vertex Buffer`,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,this.vertices),this.indexBuffer=U(e,`${this.label} Index Buffer`,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,this.indices)}vertexBuffer;indexBuffer;vertices;indices;render(e){e.setVertexBuffer(0,this.vertexBuffer),e.setIndexBuffer(this.indexBuffer,this.indexFormat),e.drawIndexed(this.indexCount)}get verticeCount(){return this.vertices.length/3}get indexCount(){return this.indices.length}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}function W(u){return`/Ocean-Simulation/${u}`}class B{constructor(e,t,i){this.code=t,this.label=i;const s=e.createShaderModule({label:this.label,code:this.code});this.shaderModule=s}shaderModule;static async joinURLContents(e){const t=e.map(i=>fetch(W(`shaders/${i}.wgsl`)).then(s=>s.text()));return(await Promise.all(t)).join("")}static async create(e,t,i,s=n=>n){const n=typeof t=="string"?[t]:t,r=await B.joinURLContents(n);return new B(e,s(r),i)}}class te extends M{constructor(e,t,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.device=e,this.label=t,this.buffer=U(e,this.label,i,this.components),this.device=e}buffer;writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components)}}class z{constructor(e,t,i,s){this.device=e,this.label=s,this.activeSkybox=-1,this.skyboxes=[],this.bindGroups=[],this.inversePespectiveViewMatrix=new te(e,`${this.label} Inverse Perspective View Matrix Buffer`),this.sampler=this.device.createSampler({label:`${this.label} Sampler`}),this.renderBindGroupLayout=this.device.createBindGroupLayout({label:`${this.label} Bind Group Layout`,entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const n=this.device.createPipelineLayout({label:`${this.label} Render Pipeline Layout`,bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:`${this.label} Render Pipeline`,layout:n,vertex:{module:t.shaderModule,entryPoint:"vertexMain"},fragment:{module:t.shaderModule,entryPoint:"fragmentMain",targets:[{format:i}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}});for(let r=0,o=this.skyboxes.length;r<o;r++){const a=this.skyboxes[r];this.skyboxes.splice(0,1),this.addSkybox(a)}}inversePespectiveViewMatrix;bindGroups=[];activeSkybox;renderBindGroupLayout;renderPipeline;skyboxes;sampler;static async create(e,t,i){const s=await B.create(e,"rendering/skybox",`${i} Shader Module`);return new z(e,s,t,i)}addSkybox(e){const t=this.device.createBindGroup({label:`${this.label} ${e.label} Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix.buffer}}]});this.skyboxes.push(e),this.bindGroups.push(t)}setActiveSkybox(e){if(e===null){this.activeSkybox=-1;return}this.skyboxes.includes(e)||this.addSkybox(e);const t=this.skyboxes.findIndex(i=>i===e);this.activeSkybox=t}render(e,t){if(this.activeSkybox===-1){console.warn("No active skybox");return}this.inversePespectiveViewMatrix.copyFrom(t.getPerspectiveViewMatrix().invert()),this.inversePespectiveViewMatrix.writeBuffer(),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroups[this.activeSkybox]),e.draw(3)}}function k(u,e,t,i){const s=i.createCommandEncoder(),n=s.beginComputePass();n.setBindGroup(0,u),n.setPipeline(e),n.dispatchWorkgroups(...t),n.end(),i.queue.submit([s.finish()])}class N{constructor(e,t,i){this.device=e,this.height=t;const s=U(e,"Butterfly Texture Bit Reversed Indices Buffer",GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE,this.bitReverseIndices(t));this.butterflyTexture=e.createTexture({label:"Butterfly Texture",format:"rgba32float",size:[Math.log2(t),t],usage:GPUTextureUsage.STORAGE_BINDING});const n=e.createBindGroupLayout({label:"Butterfly Texture Bind Group Layout",entries:[{binding:0,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Butterfly Texture Bind Group",layout:n,entries:[{binding:0,resource:{buffer:s}},{binding:1,resource:this.butterflyTexture.createView()}]});const r=e.createPipelineLayout({label:"Butterfly Texture Pipeline Layout",bindGroupLayouts:[n]});this.pipeline=e.createComputePipeline({label:"Butterfly Texture Compute Pipeline",layout:r,compute:{module:i.shaderModule,entryPoint:"main"}})}static shader=null;butterflyTexture;bindGroup;pipeline;createTexture(){k(this.bindGroup,this.pipeline,[Math.log2(this.height),this.height/64,1],this.device)}bitReverseIndices(e){const t=new Float32Array(e),i=Math.log2(e);for(let s=0;s<e;s++){let n=0;for(let r=0;r<i;r++)s&1<<r&&(n|=1<<i-1-r);t[s]=n}return t}static async getShader(e){if(this.shader===null){const t=await B.create(e,["compute/ifft/butterflyTexture","utils/complexNumber"],"Butterfly Texture Shader Module");this.shader=t}return this.shader}static async create(e,t){const i=await this.getShader(e);return new N(e,t,i)}}class ${constructor(e,t,i,s,n){this.device=e,this.spectrum=t,this.domainSize=i,this.textureSize=s,this.spectrum.createSpectrum(),this.settingsBuffer=U(e,"Height Amplitudes Settings Buffer",GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,new Float32Array([0,i])),this.texture=e.createTexture({label:"Height Amplitudes Texture",format:"rg32float",size:[s,s],usage:GPUTextureUsage.STORAGE_BINDING});const r=e.createBindGroupLayout({label:"Height Amplitudes Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Height Amplitudes Bind Group",layout:r,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:this.spectrum.spectrumTexture.createView()},{binding:2,resource:this.texture.createView()}]});const o=e.createPipelineLayout({label:"Height Amplitudes Pipeline Layout",bindGroupLayouts:[r]});this.pipeline=e.createComputePipeline({label:"Height Amplitudes Compute Pipeline",layout:o,compute:{module:n.shaderModule,entryPoint:"main"}})}settingsBuffer;bindGroup;pipeline;texture;createSpectrum(e){this.writeSettings(e,this.domainSize),k(this.bindGroup,this.pipeline,[this.textureSize/8,this.textureSize/8,1],this.device)}writeSettings(e,t){this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([e,t]))}get spectrumTexture(){return this.spectrum.spectrumTexture}static async create(e,t,i,s){const n=await B.create(e,["compute/heightAmplitudes","utils/complexNumber","utils/waveVector"],"Height Amplitudes Shader Module");return new $(e,t,i,s,n)}}class Y{constructor(e,t,i,s,n){this.device=e,this.shader=t,this.textureSize=i,this.dimensions=s,this.initialised=!1,this.permuted=e.createTexture({label:n,size:[i,i],format:this.textureFormat,usage:GPUTextureUsage.STORAGE_BINDING})}static shaders={};initialised;bindGroup_1;bindGroup_2;pipeline;ifft;permuted;get textureFormat(){return this.dimensions===1?"r32float":"rg32float"}initialise(e){if(this.initialised)return;this.ifft=e;const t=this.device.createBindGroupLayout({label:"Permute Bind Group Layout",entries:[{binding:0,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:this.textureFormat},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup_1=this.device.createBindGroup({label:"Permute Bind Group 1",layout:t,entries:[{binding:0,resource:e.texture_1.createView()},{binding:1,resource:this.permuted.createView()}]}),this.bindGroup_2=this.device.createBindGroup({label:"Permute Bind Group 2",layout:t,entries:[{binding:0,resource:e.texture_2.createView()},{binding:1,resource:this.permuted.createView()}]});const i=this.device.createPipelineLayout({label:"Permute Pipeline Layout",bindGroupLayouts:[t]});this.pipeline=this.device.createComputePipeline({label:"Permute Compute Pipeline",layout:i,compute:{module:this.shader.shaderModule,entryPoint:"main"}})}compute(){const e=this.ifft.pingPong===0?this.bindGroup_1:this.bindGroup_2;k(e,this.pipeline,[this.textureSize/8,this.textureSize/8,1],this.device)}static async getShader(e,t){if(!(t in this.shaders)){const i=t===1?"r":"rg",s=t===1?"f32":"vec2f",n=t===1?"vec4f(transformed, 0.0, 0.0, 0.0)":"vec4f(transformed, 0.0, 0.0)",r=await B.create(e,"compute/ifft/permute",`${t}d Permute Shader Module`,o=>o.replaceAll("__FORMAT__",i).replaceAll("__DATA_TYPE__",s).replaceAll("__TRANSFORM__",n));this.shaders[t]=r}return this.shaders[t]}static async create(e,t,i,s){const n=await this.getShader(e,i);return new Y(e,n,t,i,s)}}class D{constructor(e,t,i,s,n,r,o){this.device=e,this.textureSize=n,this.permute=r,this.pingPong=0,this.settingsBuffer=U(e,`${o} IFFT Settings Buffer`,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,new Float32Array([0])),this.texture_1=s,this.texture_2=e.createTexture({label:`${o} IFFT Ping Pong Texture`,format:"rg32float",size:[n,n],usage:GPUTextureUsage.STORAGE_BINDING});const a=e.createBindGroupLayout({label:`${o} IFFT Bind Group Layout`,entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rgba32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:3,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup_1=e.createBindGroup({label:`${o} IFFT Bind Group 1`,layout:a,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:t.createView()},{binding:2,resource:this.texture_1.createView()},{binding:3,resource:this.texture_2.createView()}]}),this.bindGroup_2=e.createBindGroup({label:`${o} IFFT Bind Group 2`,layout:a,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:t.createView()},{binding:2,resource:this.texture_2.createView()},{binding:3,resource:this.texture_1.createView()}]});const c=e.createPipelineLayout({label:`${o} IFFT Pipeline Layout`,bindGroupLayouts:[a]});this.pipelineHorizontal=e.createComputePipeline({label:`${o} IFFT Horizontal Compute Pipeline`,layout:c,compute:{module:i.shaderModule,entryPoint:"horizontal"}}),this.pipelineVertical=e.createComputePipeline({label:`${o} IFFT Vertical Compute Pipeline`,layout:c,compute:{module:i.shaderModule,entryPoint:"vertical"}}),r.initialise(this)}static shader=null;settingsBuffer;bindGroup_1;bindGroup_2;pipelineHorizontal;pipelineVertical;texture_1;texture_2;pingPong;compute(){this.pingPong=0;const e=Math.log2(this.textureSize);for(let t=0;t<e;t++)this.setStage(t),this.horizontal(),this.pingPong=(this.pingPong+1)%2;for(let t=0;t<e;t++)this.setStage(t),this.vertical(),this.pingPong=(this.pingPong+1)%2;this.permute.compute()}get activeTexture(){return this.permute.permuted}horizontal(){k(this.pingPong===0?this.bindGroup_1:this.bindGroup_2,this.pipelineHorizontal,[this.textureSize/8,this.textureSize/8,1],this.device)}vertical(){k(this.pingPong===0?this.bindGroup_1:this.bindGroup_2,this.pipelineVertical,[this.textureSize/8,this.textureSize/8,1],this.device)}setStage(e){this.device.queue.writeBuffer(this.settingsBuffer,0,new Uint32Array([e]))}static async getShader(e){if(this.shader===null){const t=await B.create(e,["compute/ifft/butterfly","utils/complexNumber"],"compute/ifft Shader Module");this.shader=t}return this.shader}static async create(e,t,i,s,n,r){const o=await this.getShader(e),a=r||await N.create(e,t);r===void 0&&a.createTexture();const c=await Y.create(e,t,s,n);return new D(e,a.butterflyTexture,o,i,t,c,n)}}class q{constructor(e,t,i,s,n,r,o){this.device=e,this.slopeIFFT=i,this.displacementIFFT=s,this.textureSize=r,this.settingsBuffer=U(e,"Slope and Displacement Settings Buffer",GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,new Float32Array([o]));const a=e.createBindGroupLayout({label:"Slope and Displacement Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"read-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE},{binding:3,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Slope and Displacement Bind Group",layout:a,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:n.createView()},{binding:2,resource:i.texture_1.createView()},{binding:3,resource:s.texture_1.createView()}]});const c=e.createPipelineLayout({label:"Slope and Displacement Pipeline Layout",bindGroupLayouts:[a]});this.pipeline=e.createComputePipeline({label:"Slope and Displacement Compute Pipeline",layout:c,compute:{module:t.shaderModule,entryPoint:"main"}})}settingsBuffer;bindGroup;pipeline;create(){k(this.bindGroup,this.pipeline,[this.textureSize/8,this.textureSize/8,1],this.device),this.slopeIFFT.compute(),this.displacementIFFT.compute()}get slopeVector(){return this.slopeIFFT.activeTexture}get displacementField(){return this.displacementIFFT.activeTexture}static async create(e,t,i,s,n){const r=await B.create(e,["compute/slopeAndDisplacement","utils/complexNumber","utils/waveVector"],"Slope and Displacement Shader Module"),o=e.createTexture({label:"Slope Vector Fourier Components Texture",size:[i,i],format:"rg32float",usage:GPUTextureUsage.STORAGE_BINDING}),a=e.createTexture({label:"Displacement Field Fourier Components Texture",size:[i,i],format:"rg32float",usage:GPUTextureUsage.STORAGE_BINDING}),c=await D.create(e,i,o,2,"Slope Vector",n),l=await D.create(e,i,a,2,"Displacement Field",n);return new q(e,r,c,l,t,i,s)}}class E{constructor(e,t,i,s){this.device=e,this.textureSize=i;const n=U(e,"Spectrum Settings Buffer",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,new Float32Array([t]));this.spectrumTexture=e.createTexture({label:"Spectrum Texture",format:"rg32float",size:[i,i],usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING});const r=e.createBindGroupLayout({label:"Spectrum Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rg32float"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=e.createBindGroup({label:"Spectrum Bind Group",layout:r,entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:this.spectrumTexture.createView()}]});const o=e.createPipelineLayout({label:"Spectrum Pipeline Layout",bindGroupLayouts:[r]});this.pipeline=e.createComputePipeline({label:"Spectrum Compute Pipeline",layout:o,compute:{module:s.shaderModule,entryPoint:"main"}})}static shaders={};bindGroup;pipeline;spectrumTexture;createSpectrum(){k(this.bindGroup,this.pipeline,[this.textureSize/8,this.textureSize/8,1],this.device)}static async getShader(e,t){if(!(t in E.shaders)){const i=await B.create(e,["compute/spectrum","utils/random","utils/complexNumber","utils/waveVector",`waveSpectra/${t}`],"Spectrum Shader Module");E.shaders[t]=i}return E.shaders[t]}static async create(e,t,i,s){const n=await E.getShader(e,s);return new E(e,t,i,n)}}class K{constructor(e,t,i){this.ifft=e,this.heightAmplitudes=t,this.slopeAndDisplacement=i}create(e){this.heightAmplitudes.createSpectrum(e),this.slopeAndDisplacement.create(),this.ifft.compute()}get heightMap(){return this.ifft.activeTexture}get slopeVector(){return this.slopeAndDisplacement.slopeVector}get displacementField(){return this.slopeAndDisplacement.displacementField}static async create(e,t,i,s){const n=await E.create(e,t,i,s),r=await $.create(e,n,t,i),o=await N.create(e,i);o.createTexture();const a=await D.create(e,i,r.texture,1,"Wave Height Map",o),c=await q.create(e,r.texture,i,t,o);return new K(a,r,c)}}class I{constructor(e,t){this.label=e,this.texture=t}static async create(e,t,...i){const s=i.map(async a=>await(await fetch(W(a))).blob()),n=await Promise.all(s),r=await Promise.all(n.map(a=>createImageBitmap(a))),o=e.createTexture({label:t,format:"rgba8unorm",size:[r[0].width,r[0].height,r.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let a=0;a<r.length;a++){const c=r[a];e.queue.copyExternalImageToTexture({source:c},{texture:o,origin:[0,0,a]},{width:c.width,height:c.height})}return new I(t,o)}static async createCubemap(e,t,i){return await I.create(e,t,`${i}/px.png`,`${i}/nx.png`,`${i}/py.png`,`${i}/ny.png`,`${i}/pz.png`,`${i}/nz.png`)}}const ie={arrayStride:Float32Array.BYTES_PER_ELEMENT*3,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class V{constructor(e,t,i){this.device=e,this.canvas=t;const s=this.canvas.getContext("webgpu");if(s===null)throw new Error("Could not get WebGPU Canvas context");this.ctx=s,this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),this.initialised=!1;const n=Object.assign(structuredClone(V.DEFAULT_SETTINGS),i);this.settings=n,new ResizeObserver(r=>{const o=r[0],a=o.devicePixelContentBoxSize[0].inlineSize,c=o.devicePixelContentBoxSize[0].blockSize;this.canvas.width=a,this.canvas.height=c,this.initialised&&(this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture())}).observe(this.canvas)}static DEFAULT_SETTINGS={wireframe:!1,domainSize:2e3,textureSize:512,meshSize:50,waveSpectrum:"phillips"};settings;canvasFormat;ctx;initialised;bindGroup;renderPipeline;depthTexture;cameraBuffer;settingsBuffer;skyboxRenderer;ocean;async initialise(){this.initialised||(this.ocean=await K.create(this.device,this.settings.domainSize,this.settings.textureSize,this.settings.waveSpectrum),await this.initialiseRendering())}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const e=await I.createCubemap(this.device,"Skybox Cubemap","skybox");this.skyboxRenderer=await z.create(this.device,this.canvasFormat,"Skybox Renderer"),this.skyboxRenderer.addSkybox(e),this.skyboxRenderer.setActiveSkybox(e);const t=await B.create(this.device,["rendering/vertex","rendering/fragment"],"Renderer Shader Module");this.cameraBuffer=U(this.device,"Renderer Camera Buffer",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,O.BYTE_SIZE),this.settingsBuffer=U(this.device,"Renderer Settings Buffer",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,new Float32Array([0,this.settings.meshSize,this.settings.domainSize])),this.depthTexture=this.createDepthTexture();const i=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT},{binding:1,buffer:{},visibility:GPUShaderStage.VERTEX},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:3,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:4,storageTexture:{format:"r32float",access:"read-only"},visibility:GPUShaderStage.VERTEX},{binding:5,storageTexture:{format:"rg32float",access:"read-only"},visibility:GPUShaderStage.VERTEX},{binding:6,storageTexture:{format:"rg32float",access:"read-only"},visibility:GPUShaderStage.VERTEX}]});this.bindGroup=this.device.createBindGroup({label:"Renderer Bind Group",layout:i,entries:[{binding:0,resource:{buffer:this.cameraBuffer}},{binding:1,resource:{buffer:this.settingsBuffer}},{binding:2,resource:this.skyboxRenderer.sampler},{binding:3,resource:this.skyboxRenderer.skyboxes[0].texture.createView({dimension:"cube"})},{binding:4,resource:this.ocean.heightMap.createView()},{binding:5,resource:this.ocean.slopeVector.createView()},{binding:6,resource:this.ocean.displacementField.createView()}]});const s=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[i]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:s,vertex:{module:t.shaderModule,entryPoint:"vertexMain",buffers:[ie]},fragment:{module:t.shaderModule,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{topology:this.settings.wireframe?"line-list":"triangle-list",cullMode:"front"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),this.initialised=!0}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:this.canvas,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}render(e,t,i){if(!this.initialised){console.error("Renderer not initialised");return}this.ocean.create(i),e.aspectRatio=this.canvas.width/this.canvas.height,this.device.queue.writeBuffer(this.cameraBuffer,0,e.writeToBuffer()),this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([i]));const s=this.device.createCommandEncoder({label:"Renderer Command Encoder"}),n=s.beginRenderPass({label:"Renderer Render Pass",colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});n.setBindGroup(0,this.bindGroup),n.setPipeline(this.renderPipeline);for(const r of t)try{r.render(n,e)}catch(o){console.error("Error while trying to render object",o)}this.skyboxRenderer.render(n,e),n.end(),this.device.queue.submit([s.finish()])}static async create(e,t={}){if(!navigator.gpu)throw new Error("WebGPU not supported");const i=await navigator.gpu.requestAdapter();if(i===null)throw new Error("No GPU Adapter found");const s=await i.requestDevice();return new V(s,e,t)}}class se{callbacks;animationFrameID;lastTick;constructor(){this.callbacks=[],this.animationFrameID=null,this.lastTick=0}start(){this.animationFrameID!==null&&cancelAnimationFrame(this.animationFrameID),this.tick(0)}stop(){this.animationFrameID!==null&&(cancelAnimationFrame(this.animationFrameID),this.animationFrameID=null)}tick(e){const t=e-this.lastTick,i=t/1e3,s={deltaTimeMS:t,deltaTimeSeconds:i,totalTimeMS:e};for(const n of this.callbacks)n(s);this.lastTick=e,this.animationFrameID=requestAnimationFrame(n=>this.tick.bind(this)(n))}addCallback(e){this.callbacks.push(e)}removeCallback(e){const t=this.callbacks.findIndex(i=>i===e);if(t===-1){console.warn("Callback not found");return}this.callbacks.splice(t,1)}}function ne(u,e){const t=e/u,s=-.09784735812133072-.5*(1-1/u)*e,n=[],r=[],o=(u+1)**2;for(let a=0;a<o;a++){const c=Math.floor(a/(u+1)),l=a-(u+1)*c;n.push(s+l*t,0,s+c*t)}for(let a=0;a<u;a++){const c=a*(u+1),l=(a+1)*(u+1);for(let p=0;p<u;p++)r.push(c+p+1,l+p+1,l+p,c+p,c+p+1,l+p)}return{vertices:n,indices:r}}const X=document.querySelector(".loading");re().then(()=>{X.remove()}).catch(u=>{throw X.textContent=u instanceof Error?u.message:typeof u=="string"?u:JSON.stringify(u),alert(u),u});async function re(){const u=document.querySelector("canvas");if(u===null)throw new Error("Could not find canvas");u.addEventListener("click",()=>{u.requestPointerLock()});const e=50,t=512,i=await V.create(u,{wireframe:!1,meshSize:e,domainSize:2e3,textureSize:t,waveSpectrum:"phillips"});await i.initialise();const s=new O({position:new v(0,5,-25),movementSpeed:10,pitch:-20,yaw:90}),n=ne(t-1,e),r=new ee(i.device,n.vertices,n.indices,"Ocean Mesh"),o=new se,a=c=>{const l=c.totalTimeMS/1e3;c.deltaTimeMS<500&&s.checkKeyboardInputs(c.deltaTimeSeconds),i.render(s,[r],l)};o.addCallback(a),o.start()}
